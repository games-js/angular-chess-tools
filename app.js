angular.module("chess",["chess.services","chess.controllers","chess.directives","chess.filters","ngAnimate"]).config([function(){}]);
angular.module("chess.services",[]);
angular.module("chess.services").constant("chessConstants",{moveMode:{dragndrop:"dragndrop",click:"click"},control:{all:"all",edit:"edit",user:"user"},user:{white:"white",black:"black"}});
angular.module("chess.services").provider("chessResources",function(){var t={imgsRootPath:"/imgs"};this.setImgsRootPath=function(s){var e=s;void 0!==e&&("/"===s.substring(s.length-1)&&(e=s.substring(0,s.length-1)),t.imgsRootPath=e)},this.$get=[function(){var s=function(){this.getImgsRootPath=function(){return t.imgsRootPath},this.getPieceImage=function(t,s){return this.getImgsRootPath()+"/"+t+"_"+s+".svg"},this.getTrash=function(){return this.getImgsRootPath()+"/trash.svg"}};return new s}]});
angular.module("chess.services").factory("chessPieceService",function(){var o=function(){var o=this;this.types={KING:"king",QUEEN:"queen",ROOK:"rook",BISHOP:"bishop",KNIGHT:"knight",PAWN:"pawn"},this.colors={WHITE:"white",BLACK:"black"};var n=function(n){for(var t in o.types)if(o.types[t]===n)return t},t=function(n){for(var t in o.colors)if(o.colors[t]===n)return t},i=function(o,i,r,e){this.type=n(o),this.colorType=t(i),this.name=o,this.color=i,this.x=r,this.y=e};this.new=function(n,t,r,e){if(void 0===o.types[n])throw"Unknown piece name :"+n;if(void 0===o.colors[t])throw"Unknown color :"+t;if(0>r||r>7||0>e||e>7)throw"Position unauthorized : ("+r+","+e+")";return new i(o.types[n],o.colors[t],r,e)},this.clone=function(n){return o.new(n.type,n.colorType,n.x,n.y)},this.fromData=function(o){return new i(o.name,o.color,o.x,o.color)},this.setPosition=function(o,n,t){if(0>n||n>7||0>t||t>7)throw"Position unauthorized : ("+n+","+t+")";o.x=n,o.y=t}};return new o});
angular.module("chess.services").provider("chessPositionService",function(){var i,n,e=[],o=!1,t=[];this.setPosition=function(i){e=i,o=!0},this.$get=["chessPieceService",function(s){var r=function(){if(!o){var t,r,f;for(r=0;64>r;r++)e.push(void 0);for(t=0;8>t;t++)c(s.new("PAWN","WHITE",t,1)),c(s.new("PAWN","BLACK",t,6));for(r=0,f=[0,7];r<f.length;r++)c(s.new("ROOK","WHITE",f[r],0)),c(s.new("ROOK","BLACK",f[r],7));for(r=0,f=[2,5];r<f.length;r++)c(s.new("BISHOP","WHITE",f[r],0)),c(s.new("BISHOP","BLACK",f[r],7));for(r=0,f=[1,6];r<f.length;r++)c(s.new("KNIGHT","WHITE",f[r],0)),c(s.new("KNIGHT","BLACK",f[r],7));c(s.new("QUEEN","WHITE",3,0)),c(s.new("QUEEN","BLACK",3,7)),i=s.new("KING","WHITE",4,0),n=s.new("KING","BLACK",4,7),c(i),c(n)}},c=function(i,n){var o=n?n:e,t=i.x,s=i.y;indice=8*s+t,o[indice]=i},f=function(i,n,o){var t=o?o:e;t[8*n+i]=void 0},u=function(i,n){f(i.x,i.y,n)},h=function(){return this.lastMove},v=!1,a=function(){return v},l=function(i,n,e,o){var t=function(){this.lastMove={from:{x:i.x,y:i.y},to:{x:n,y:e}},v=!0};if(v=!1,void 0!==o){var s;for(var r in o)if(s=o[r],s.x===n&&s.y===e){t.apply(this);break}}else t.apply(this)},p=function(i,n,o,t){var r=t?t:e,f=i.x,u=i.y;sourceInd=8*u+f,r[sourceInd]=void 0,s.setPosition(i,n,o),c(i,r),v=!1},K=function(){return e},P=function(i,n,o){return posToUse=o?o:e,posToUse[8*n+i]},I=function(e,o){var s,r;if(o)for(var c in t){var f=t[c];f.position===o&&(s=f.whiteKing,r=f.blackKing)}else s=i,s=n;return"WHITE"===e?s:r},d=function(i){e=i},w=function(){for(var i in e)e[i]=void 0},g=function(){var i,n,o,r=[];for(var c in e)i=e[c],i&&(i=s.clone(i),"KING"===i.type&&("WHITE"===i.colorType?o=i:n=i)),r.push(i);return t.push({whiteKing:o,blackKing:n,position:r}),r},T=function(i){for(var n in t){var e=t[n];if(e.position===i){t.splice(n,1);break}}},E=function(){r(),this.addPiece=c,this.dropPosition=f,this.dropPiece=u,this.getLastMove=h,this.isMoveAccepted=a,this.checkMove=l,this.movePiece=p,this.getPosition=K,this.getPiece=P,this.getKing=I,this.setNewPosition=d,this.clearPosition=w,this.clonePosition=g,this.unclonePosition=T};return new E}]});
angular.module("chess.services").factory("chessMoveService",["chessPositionService",function(r){var e=function(r,e){for(var n=[],o=r-1;o>=0;o--)n.push([o,e]);return n},n=function(r,e){for(var n=[],o=r+1;7>=o;o++)n.push([o,e]);return n},o=function(r,e){for(var n=[],o=e-1;o>=0;o--)n.push([r,o]);return n},i=function(r,e){for(var n=[],o=e+1;7>=o;o++)n.push([r,o]);return n},t=function(r,e){for(var n=[],o=0,i=r-1;i>=0&&(o++,!(e+o>7));i--)n.push([i,e+o]);return n},u=function(r,e){for(var n=[],o=0,i=r-1;i>=0&&(o++,!(0>e-o));i--)n.push([i,e-o]);return n},a=function(r,e){for(var n=[],o=0,i=r+1;7>=i&&(o++,!(0>e-o));i++)n.push([i,e-o]);return n},v=function(r,e){for(var n=[],o=0,i=r+1;7>=i&&(o++,!(e+o>7));i++)n.push([i,e+o]);return n},c=function(r,e){var n,o=[],i=[[1,2],[1,-2],[2,1],[2,-1],[-1,2],[-1,-2],[-2,1],[-2,-1]];for(var t in i)n=i[t],r+n[0]>=0&&r+n[0]<=7&&e+n[1]>=0&&e+n[1]<=7&&o.push([r+n[0],e+n[1]]);return o},f=function(e,n,o,i){if(!(e>=0&&8>e&&n>=0&&8>n))return!1;var t=r.getPiece(e,n,i);return!t||t.colorType!==o&&"KING"!==t.type},s=function(r,e,n){var o=[],i=[[-1,-1],[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1],[0,-1]];for(var t in i){var u=i[t];x=e.x+u[0],y=e.y+u[1],f(x,y,r,n)&&o.push({x:x,y:y})}return o},p=function(y,c,x){var s=[],p=[e(c.x,c.y),n(c.x,c.y),i(c.x,c.y),o(c.x,c.y),t(c.x,c.y),v(c.x,c.y),u(c.x,c.y),a(c.x,c.y)];for(var h in p){var P=p[h];for(var g in P){var T=P[g],l={x:T[0],y:T[1]};if(!f(l.x,l.y,y,x))break;s.push(l);var I=r.getPiece(l.x,l.y,x);if(void 0!==I)break}}return s},h=function(t,u,y){var a=[],v=[e(u.x,u.y),n(u.x,u.y),i(u.x,u.y),o(u.x,u.y)];for(var c in v){var x=v[c];for(var s in x){var p=x[s],h={x:p[0],y:p[1]};if(!f(h.x,h.y,t,y))break;a.push(h);var P=r.getPiece(h.x,h.y,y);if(void 0!==P)break}}return a},P=function(e,n,o){var i=[],y=[t(n.x,n.y),u(n.x,n.y),v(n.x,n.y),a(n.x,n.y)];for(var c in y){var x=y[c];for(var s in x){var p=x[s],h={x:p[0],y:p[1]};if(!f(h.x,h.y,e,o))break;i.push(h);var P=r.getPiece(h.x,h.y,o);if(void 0!==P)break}}return i},g=function(r,e,n){var o=[],i=c(e.x,e.y);for(var t in i){var u=i[t],y=u[0],a=u[1];f(y,a,r,n)&&o.push({x:y,y:a})}return o},T=function(e,n,o){var i=[];if(0===n.y&&"BLACK"===e||7===n.y&&"WHITE"===e)return i;var t="WHITE"===e?n.y+1:n.y-1,u=r.getPiece(n.x,t,o);u||i.push({x:n.x,y:t}),!u&&(1===n.y&&"WHITE"===e||6===n.y&&"BLACK"===e)&&(t="WHITE"===e?n.y+2:n.y-2,u=r.getPiece(n.x,t,o),u||i.push({x:n.x,y:t}));var y,a,v,c;return n.x>0&&(y={x:n.x-1,y:"WHITE"===e?n.y+1:n.y-1}),n.x<7&&(a={x:n.x+1,y:"WHITE"===e?n.y+1:n.y-1}),y&&(v=r.getPiece(y.x,y.y,o),v&&v.colorType!==e&&i.push(y)),a&&(c=r.getPiece(a.x,a.y,o),c&&c.colorType!==e&&i.push(a)),i},l=function(r,e,n,o){switch(r){case"KING":return s(e,n,o);case"QUEEN":return p(e,n,o);case"ROOK":return h(e,n,o);case"BISHOP":return P(e,n,o);case"KNIGHT":return g(e,n,o);case"PAWN":return T(e,n,o)}},I=function(e,n){var o=r.getKing(n,e),i=["PAWN","ROOK","BISHOP","KNIGHT","QUEEN"];for(var t in i){var u=i[t],y=l(u,n,{x:o.x,y:o.y},e);for(var t in y){var a=y[t],v=r.getPiece(a.x,a.y,e);if(v&&v.colorType!==n&&v.type===u)return!0}}},K=function(e){var n=[],o=l(e.type,e.colorType,{x:e.x,y:e.y},r.getPosition());if(o&&o.length>0){var i=r.clonePosition();r.dropPiece(e,i);var t=void 0;"KING"!==e.type&&(t=I(i,e.colorType)),r.unclonePosition(i);var u,y=t||"KING"===e.type;for(var a in o){var v=o[a];y?(i=r.clonePosition(),u=r.getPiece(e.x,e.y,i),r.movePiece(u,v.x,v.y,i),I(i,u.colorType)||n.push(v),r.unclonePosition(i)):n.push(v)}}return n},E=function(){this.getMoves=K};return new E}]);
angular.module("chess.services").factory("chessDragDropMove",["chessPieceService","chessConstants",function(e,t){var a=function(){this.activate=function(a,n,o){a.on("dragover",function(e){e.preventDefault&&e.preventDefault()}),a.on("dragenter",function(){this.classList.add("overSquare")}),a.on("dragleave",function(e){this.classList.remove("overSquare"),e.stopPropagation()}),a.on("dragstart",function(e){var t=n.getScope(),a="in "+t.content.piece.x+" "+t.content.piece.y,r=t.getImage()[0],i=r.width/2,s=r.height/2;e.dataTransfer.setData("piece",a),e.dataTransfer.setDragImage(r,i,s),t.$apply(function(){o.displayAccessibleMoves(t.content.piece)})}),a.on("drop",function(a){a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),this.classList.remove("overSquare");var r=a.dataTransfer.getData("piece");if(void 0!==r){var i=r.split(" "),s=i[0],c=o.getControl(),f=n.getScope();if("in"===s){var p=parseInt(i[1]),v=parseInt(i[2]);o.tryMove(p,v,f.content.x,f.content.y)}else if("out"===s&&c===t.control.edit){var d=i[1],g=i[2];piece=e.new(d,g,f.content.x,f.content.y),o.addPiece(piece)}}})},this.deactivate=function(e){e.off("dragover"),e.off("dragenter"),e.off("dragleave"),e.off("dragstart"),e.off("drop")}};return new a}]);
angular.module("chess.services").factory("clickTracker",function(){var t=function(){var t,e;this.setX=function(e){t=e},this.getX=function(){return t},this.setY=function(t){e=t},this.getY=function(){return e},this.reset=function(){t=e=void 0}};return new t}).factory("chessClickMove",["clickTracker",function(t){var e=function(){this.activate=function(e,n,c){e.on("click",function(){var e=t.getX(),i=t.getY(),o=n.getScope(),r=o.content.piece;if(void 0===e||void 0===i){if(!r)return;o.isMovable()&&(t.setX(r.x),t.setY(r.y),o.$apply(function(){c.displayAccessibleMoves(o.content.piece)}))}else t.reset(),c.tryMove(e,i,o.content.x,o.content.y)})},this.deactivate=function(t){t.off("click")}};return new e}]);
angular.module("chess.controllers",[]);
angular.module("chess.directives",["chess.services"]);
angular.module("chess.directives").directive("chessBoardDirective",["$animate","$log","chessConstants","chessPositionService","chessMoveService",function(e,s,o,i,t){return{replace:!0,transclude:!1,scope:{user:"=",displayCoordinates:"=",moveMode:"=",displayAccessibleSquares:"=?",control:"="},template:'<div id="chessBoardContainer">	<div id="chessBoard" ng-class="cssClasses()">		<chess-square-directive 			chess-square-move 			ng-repeat="piece in getPosition() track by $index" 			x="{{getX($index)}}" 			y="{{getY($index)}}" 			piece="{{piece}}" 			reverse="{{isReverse(user)}}" 		> 	</div> 	<div id="rightCoordinates" ng-if="displayCoordinates" ng-class="cssClasses()"> 		<div ng-repeat="indice in [] | range:8 | increment:1" ng-class="cssClasses()">{{indice}}</div> 	</div> 	<div id="bottomCoordinates"  ng-if="displayCoordinates" ng-class="cssClasses()"> 		<div ng-repeat="indice in [] | range:8 | asLetter | reverse" ng-class="cssClasses()">{{indice}}</div> 	</div> </div>',controller:["$scope","$element",function(n,c){var r=this;n.getPosition=i.getPosition,n.position=i.getPosition(),n.$watch(i.isMoveAccepted,function(s){if(s===!0){var o=i.getLastMove();if(o){var t=a(o.from.x,o.from.y),c=r.squareScopes[t],d=c.getImage(),v=n.position[t],l=(o.to.x-o.from.x)*d[0].width,u=(o.from.y-o.to.y)*d[0].height;e.animate(d,{top:0,left:0},{top:u+"px",left:l+"px"}).then(function(){n.$apply(function(){i.movePiece(v,o.to.x,o.to.y)})})}}}),n.cssClasses=function(){return{reverse:n.isReverse(n.user)}},n.getX=function(e){return e%8},n.getY=function(e){return Math.floor(e/8)};var a=function(e,s){return 8*s+e};this.squareScopes=[],n.isReverse=function(e){return e?e===o.user.white:void 0},this.getControl=function(){return n.control},this.getMoveMode=function(){return n.moveMode},this.isMovable=function(e){return!e.isEmpty&&n.user?n.control===o.control.all||n.control===o.control.edit||n.control===o.control.user&&e.content.piece.color==n.user:void 0},this.registerSquareScope=function(e){var s=e.content.x,o=e.content.y;this.squareScopes[8*o+s]=e},this.needCheckMoves=function(){return n.control!==o.control.edit},this.tryMove=function(e,s,o,t){var c=a(e,s),d=n.position[c];n.$apply(function(){i.checkMove(d,o,t,n.accessibleMoves),r.hidePreviousMoves(!0)})},this.addPiece=function(e){n.$apply(function(){i.addPiece(e)})},n.accessibleMoves,this.displayMoves=function(e){e&&e.forEach(function(e){r.squareScopes[8*e.y+e.x].content.highlight=!0})},this.displayAccessibleMoves=function(e){this.needCheckMoves()&&n.displayAccessibleSquares&&(n.accessibleMoves=t.getMoves(e),this.displayMoves(n.accessibleMoves))},this.hidePreviousMoves=function(e){if(this.needCheckMoves()&&n.displayAccessibleSquares&&n.accessibleMoves){for(var s in n.accessibleMoves)move=n.accessibleMoves[s],this.squareScopes[8*move.y+move.x].content.highlight=!1;e&&(n.accessibleMoves=void 0)}};var d=!1;this.applyMoveMode=function(e){if(e){switch(e){case o.moveMode.dragndrop:c.on("dragenter",function(e){var s=e.target||e.srcElement;s===c[0]?(d=!0,n.$apply(function(){r.hidePreviousMoves(!1)})):d&&(d=!1,n.$apply(function(){r.displayMoves(n.accessibleMoves)}))});break;case o.moveMode.click:c.off("dragenter");break;default:s.error("Unknow move mode: "+e)}var i;for(var t in r.squareScopes)i=r.squareScopes[t],i.applyMoveMode?i.applyMoveMode(e):s.error("applyMoveMode undefined on square scope")}},n.$watch("moveMode",this.applyMoveMode),n.$watch("control",function(e){e===o.control.edit&&(n.moveMode=o.moveMode.dragndrop)})}]}}]);
angular.module("chess.directives").directive("chessSquareDirective",["chessResources",function(e){return{require:"^chessBoardDirective",replace:!0,transclude:!1,scope:{x:"@",y:"@",piece:"@?",reverse:"@"},template:' <div 	ng-class="cssClasses()"  > 	<img ng-if="!isEmpty" ng-src="{{imgSource()}}" draggable="{{isMovable()}}"></img> </div>',controller:["$scope",function(e){this.getScope=function(){return e}}],link:function(i,t,r,n){var c=function(){i.content={x:parseInt(i.x),y:parseInt(i.y),piece:void 0!==i.piece&&""!==i.piece?JSON.parse(i.piece):void 0},i.isEmpty=void 0===i.content.piece};c(),i.$watch("piece",function(){c()}),i.cssClasses=function(){var e=!0,t=(i.content.x+i.content.y)%2===0;return whiteSquare=!t,firstOfLine=0===i.content.x,reverse="true"===i.reverse,highlightSquareEmpty=i.content.highlight&&i.isEmpty,highlightSquareFilled=i.content.highlight&&!i.isEmpty,{square:e,blackSquare:t,whiteSquare:whiteSquare,firstOfLine:firstOfLine,reverse:reverse,highlightSquareEmpty:highlightSquareEmpty,highlightSquareFilled:highlightSquareFilled}},i.imgSource=function(){return i.isEmpty?void 0:e.getPieceImage(i.content.piece.name,i.content.piece.color)},i.getImage=function(){return i.isEmpty?void 0:t.find("img")},i.isMovable=function(){return n.isMovable(i)},n.registerSquareScope(i)}}}]);
angular.module("chess.directives").directive("chessSquareMove",["$log","chessDragDropMove","chessClickMove","chessConstants",function(e,o,c,t){return{require:["chessSquareDirective","^chessBoardDirective"],restrict:"A",link:function(a,r,i,s){var v=s[0],d=s[1],n=d.getMoveMode();v.getScope().applyMoveMode=function(a){switch(a){case t.moveMode.dragndrop:c.deactivate(r,v,d),o.activate(r,v,d);break;case t.moveMode.click:o.deactivate(r,v,d),c.activate(r,v,d);break;default:e.error("unknown move mode: "+a)}},v.getScope().applyMoveMode(n)}}}]);
angular.module("chess.directives").directive("chessDraggablePieceDirective",[function(){return{restrict:"A",scope:{type:"@",color:"@"},link:function(e,r){r.on("dragstart",function(r){var t="out "+e.type+" "+e.color;r.dataTransfer.setData("piece",t)})}}}]).directive("chessDroppableTrash",["chessPositionService",function(e){return{restrict:"A",scope:{},link:function(r,t){t.on("dragover",function(e){e.preventDefault&&e.preventDefault()}),t.on("drop",function(t){t.stopPropagation();var i=t.dataTransfer.getData("piece");if(void 0!==i){var o=i.split(" "),c=o[0];if("in"===c){var s=parseInt(o[1]),n=parseInt(o[2]);r.$apply(function(){e.dropPosition(s,n)})}}})}}}]).directive("chessEditBoardDirective",["chessPieceService","chessPositionService","chessResources",function(e,r,t){return{restrict:"E",replace:!0,transclude:!1,scope:{},template:'<ul class="editBoardContainer"style="list-style-type: none;">	<button ng-click="clearBoard()">clear board</button>	<li ng-repeat="(keyType, type) in types">		<ul> 			<li 				class="editsquare" 				style="display:inline-block;" 				ng-repeat="(keyColor, color) in colors" 			>            	<img 					ng-src="{{imgSource(type, color)}}" 					draggable="true" 					chess-draggable-piece-directive 					type="{{keyType}}" 					color="{{keyColor}}" 				/> 			</li>		</ul> 	</li>	<li class="trash" chess-droppable-trash>		<img src="{{imgTrash()}}" />	</li></div>',link:function(i){i.types=e.types,i.type="KING",i.colors=e.colors,i.imgSource=function(e,r){return t.getPieceImage(e,r)},i.imgTrash=function(){return t.getTrash()},i.clearBoard=function(){r.clearPosition()}}}}]);
angular.module("chess.filters",[]);
angular.module("chess.filters").filter("range",function(){return function(r,n,t){for(var e=[],u=0;n>u;u++){var f=t?n-1-u:u;e.push(f)}return e}}).filter("reverse",function(){return function(r){for(var n=[],t=0;t<r.length;t++)n.push(r[r.length-t-1]);return n}}).filter("increment",function(){return function(r,n){for(var t=[],e=0;e<r.length;e++)t.push(r[e]+n);return t}}).filter("asLetter",function(){return function(r){for(var n,t=[],e=0;e<r.length;e++)n=r[e]+3,t.push(String.fromCharCode(94+n));return t}});
angular.module("chess",["chess.services","chess.controllers","chess.directives","chess.filters","ngAnimate"]).config([function(){}]);
angular.module("sample",["chess"]).config(["chessResourcesProvider",function(e){e.setImgsRootPath("/angular-chess-tools/imgs")}]).controller("mainController",["$scope","chessPositionService","chessPieceService",function(e,o,c){e.color="white",e.changeColor=function(){e.color="white"==e.color?"black":"white"},e.accessibleMoves=!1,e.switchAccessibleMoves=function(){e.accessibleMoves=!e.accessibleMoves},e.moveMode="dragndrop",e.switchMoveMode=function(){e.moveMode="dragndrop"===e.moveMode?"click":"dragndrop"},e.checkMove=function(){var e=c.new("KNIGHT","BLACK",1,7);o.checkMove(e,0,5)},e.control="user",e.setControl=function(o){e.control=o},e.isEditable=function(){return"edit"===e.control},e.buttons=[{label:"change color",fn:e.changeColor,desc:"Rotate the chessboard and so the user color.",currentVal:"color"},{label:"Hide/display moves",fn:e.switchAccessibleMoves,desc:"Display or hide the accessible moves when dragging a piece.			If not selected, wrong moves are possible.",currentVal:"accessibleMoves"},{label:"Change move mode",fn:e.switchMoveMode,desc:"Moves can be done by dragNdrop or by clicking source and target squares.",currentVal:"moveMode"},{label:"check automated move",fn:e.checkMove,desc:"How does the piece moves when it's not a user action"},{label:"control user",fn:function(){e.setControl("user")},desc:"Limit the user control to its pieces",currentVal:"control"},{label:"control all",fn:function(){e.setControl("all")},desc:"All pieces are movable",currentVal:"control"},{label:"edit board",fn:function(){e.setControl("edit")},desc:"Edit a position"}],e.setButtonActive=function(o){for(var c in e.buttons)e.buttons[c].active=!1;o.active=!0,o.fn(),e.currentVal=e[o.currentVal]},e.buttonOverLeave=function(o,c,t){e.description=o,e.currentVal=e[c],t.over=o&&o.length>0?!0:!1}}]);