function _pst2Black(t,i){for(var s=0;12>s;s++)for(var e=12*s,r=12*(11-s),o=0;12>o;o++)i[r+o]=t[e+o]}function lozChess(){this.nodes=Array(MAX_PLY);for(var t=null,i=0;i<this.nodes.length;i++)this.nodes[i]=new lozNode(t),this.nodes[i].ply=i,t=this.nodes[i],this.nodes[i].root=0==i;this.board=new lozBoard,this.stats=new lozStats,this.uci=new lozUCI,this.rootNode=this.nodes[0];for(var i=0;i<this.nodes.length;i++)this.nodes[i].board=this.board;return this}function lozBoard(){this.lozza=null,this.verbose=!1,this.tab="",this.b=Array(144),this.z=Array(144),this.wList=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.bList=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.runningEvalS=0,this.runningEvalE=0,this.rights=0,this.ep=0,this.repLo=0,this.repHi=0,this.loHash=0,this.hiHash=0,this.ploHash=0,this.phiHash=0,this.ttSize=1<<24,this.ttMask=this.ttSize-1,this.ttLo=new Int32Array(this.ttSize),this.ttHi=new Int32Array(this.ttSize),this.ttType=new Uint8Array(this.ttSize),this.ttDepth=new Int8Array(this.ttSize),this.ttMove=new Uint32Array(this.ttSize),this.ttScore=new Int16Array(this.ttSize),this.pttSize=16384,this.pttMask=this.pttSize-1,this.pttLo=new Int32Array(this.pttSize),this.pttHi=new Int32Array(this.pttSize),this.pttType=new Uint8Array(this.pttSize),this.pttScoreS=new Int16Array(this.pttSize),this.pttScoreE=new Int16Array(this.pttSize),this.ttInit(),this.turn=0,this.loTurn=this.rand32(),this.hiTurn=this.rand32(),this.loPieces=Array(2);for(var t=0;2>t;t++){this.loPieces[t]=Array(6);for(var i=0;6>i;i++){this.loPieces[t][i]=Array(144);for(var s=0;144>s;s++)this.loPieces[t][i][s]=this.rand32()}}this.hiPieces=Array(2);for(var t=0;2>t;t++){this.hiPieces[t]=Array(6);for(var i=0;6>i;i++){this.hiPieces[t][i]=Array(144);for(var s=0;144>s;s++)this.hiPieces[t][i][s]=this.rand32()}}this.loRights=Array(16),this.hiRights=Array(16);for(var t=0;16>t;t++)this.loRights[t]=this.rand32(),this.hiRights[t]=this.rand32();this.loEP=Array(144),this.hiEP=Array(144);for(var t=0;144>t;t++)this.loEP[t]=this.rand32(),this.hiEP[t]=this.rand32();this.repLoHash=Array(1e3);for(var t=0;1e3>t;t++)this.repLoHash[t]=0;this.repHiHash=Array(1e3);for(var t=0;1e3>t;t++)this.repHiHash[t]=0;this.phase=0,this.gPhase=0,this.wCounts=[0,0,0,0,0,0,0],this.bCounts=[0,0,0,0,0,0,0],this.wCount=0,this.bCount=0,this.wPawns=[9,9,9,9,9,9,9,9,9,9],this.bPawns=[0,0,0,0,0,0,0,0,0,0],this.mobilityS=0,this.mobilityE=0,this.wHistory=Array(7);for(var t=0;7>t;t++){this.wHistory[t]=Array(144);for(var i=0;144>i;i++)this.wHistory[t][i]=0}this.bHistory=Array(7);for(var t=0;7>t;t++){this.bHistory[t]=Array(144);for(var i=0;144>i;i++)this.bHistory[t][i]=0}}function lozNode(t){this.ply=0,this.root=!1,this.childNode=null,this.parentNode=t,t?(this.grandparentNode=t.parentNode,t.childNode=this):this.grandparentNode=null,this.moves=Array(MAX_MOVES);for(var i=0;i<this.moves.length;i++)this.moves[i]=[0,0];this.killer1=0,this.killer2=0,this.mateKiller=0,this.numMoves=0,this.sortedIndex=0,this.hashMove=0,this.base=0,this.C_runningEvalS=0,this.C_runningEvalE=0,this.C_rights=0,this.C_ep=0,this.C_repLo=0,this.C_repHi=0,this.C_loHash=0,this.C_hiHash=0,this.C_ploHash=0,this.C_phiHash=0,this.toZ=0,this.frZ=0,this.epZ=0}function lozStats(){}function lozUCI(){this.message="",this.tokens=[],this.command="",this.spec={},this.debugging=!1,this.tuning=!1,this.tune1=0,this.options={}}angular.module("chess",["chess.services","chess.controllers","chess.directives","chess.filters","ngAnimate"]).config([function(){}]),angular.module("chess.directives",["chess.services"]),angular.module("chess.directives").directive("chessBoardDirective",["$animate","$log","chessConstants","chessPositionService","chessMoveService",function(t,i,s,e,r){return{replace:!0,transclude:!1,scope:{user:"=",displayCoordinates:"=",moveMode:"=",displayAccessibleSquares:"=?",control:"="},template:'<div id="chessBoardContainer">	<div id="chessBoard" ng-class="cssClasses()">		<chess-square-directive 			chess-square-move 			ng-repeat="piece in getPosition() track by $index" 			x="{{getX($index)}}" 			y="{{getY($index)}}" 			piece="{{piece}}" 			reverse="{{isReverse(user)}}" 		> 	</div> 	<div id="rightCoordinates" ng-if="displayCoordinates" ng-class="cssClasses()"> 		<div ng-repeat="indice in [] | range:8 | increment:1" ng-class="cssClasses()">{{indice}}</div> 	</div> 	<div id="bottomCoordinates"  ng-if="displayCoordinates" ng-class="cssClasses()"> 		<div ng-repeat="indice in [] | range:8 | asLetter | reverse" ng-class="cssClasses()">{{indice}}</div> 	</div> </div>',controller:["$scope","$element",function(o,h){var n=this;o.getPosition=e.getPosition,o.position=e.getPosition(),o.$watch(e.isMoveAccepted,function(i){if(i===!0){var s=e.getLastMove();if(s){var r=a(s.from.x,s.from.y),h=n.squareScopes[r],E=h.getImage(),c=o.position[r],S=(s.to.x-s.from.x)*E[0].width,_=(s.from.y-s.to.y)*E[0].height;t.animate(E,{top:0,left:0},{top:_+"px",left:S+"px"}).then(function(){o.$apply(function(){e.movePiece(c,s.to.x,s.to.y)})})}}}),o.cssClasses=function(){return{reverse:o.isReverse(o.user)}},o.getX=function(t){return t%8},o.getY=function(t){return Math.floor(t/8)};var a=function(t,i){return 8*i+t};this.squareScopes=[],o.isReverse=function(t){return t?t===s.user.white:void 0},this.getControl=function(){return o.control},this.getMoveMode=function(){return o.moveMode},this.isMovable=function(t){return!t.isEmpty&&o.user?o.control===s.control.all||o.control===s.control.edit||o.control===s.control.user&&t.content.piece.color==o.user:void 0},this.registerSquareScope=function(t){var i=t.content.x,s=t.content.y;this.squareScopes[8*s+i]=t},this.needCheckMoves=function(){return o.control!==s.control.edit},this.tryMove=function(t,i,s,r){var h=a(t,i),E=o.position[h];o.$apply(function(){e.checkMove(E,s,r,o.accessibleMoves),n.hidePreviousMoves(!0)})},this.addPiece=function(t){o.$apply(function(){e.addPiece(t)})},o.accessibleMoves,this.displayMoves=function(t){t&&t.forEach(function(t){n.squareScopes[8*t.y+t.x].content.highlight=!0})},this.displayAccessibleMoves=function(t){this.needCheckMoves()&&o.displayAccessibleSquares&&(o.accessibleMoves=r.getMoves(t),this.displayMoves(o.accessibleMoves))},this.hidePreviousMoves=function(t){if(this.needCheckMoves()&&o.displayAccessibleSquares&&o.accessibleMoves){for(var i in o.accessibleMoves)move=o.accessibleMoves[i],this.squareScopes[8*move.y+move.x].content.highlight=!1;t&&(o.accessibleMoves=void 0)}};var E=!1;this.applyMoveMode=function(t){if(t){switch(t){case s.moveMode.dragndrop:h.on("dragenter",function(t){var i=t.target||t.srcElement;i===h[0]?(E=!0,o.$apply(function(){n.hidePreviousMoves(!1)})):E&&(E=!1,o.$apply(function(){n.displayMoves(o.accessibleMoves)}))});break;case s.moveMode.click:h.off("dragenter");break;default:i.error("Unknow move mode: "+t)}var e;for(var r in n.squareScopes)e=n.squareScopes[r],e.applyMoveMode?e.applyMoveMode(t):i.error("applyMoveMode undefined on square scope")}},o.$watch("moveMode",this.applyMoveMode),o.$watch("control",function(t){t===s.control.edit&&(o.moveMode=s.moveMode.dragndrop)})}]}}]),angular.module("chess.directives").directive("chessDraggablePieceDirective",[function(){return{restrict:"A",scope:{type:"@",color:"@"},link:function(t,i){i.on("dragstart",function(i){var s="out "+t.type+" "+t.color;i.dataTransfer.setData("piece",s)})}}}]).directive("chessDroppableTrash",["chessPositionService",function(t){return{restrict:"A",scope:{},link:function(i,s){s.on("dragover",function(t){t.preventDefault&&t.preventDefault()}),s.on("drop",function(s){s.stopPropagation();var e=s.dataTransfer.getData("piece");if(void 0!==e){var r=e.split(" "),o=r[0];if("in"===o){var h=parseInt(r[1]),n=parseInt(r[2]);i.$apply(function(){t.dropPosition(h,n)})}}})}}}]).directive("chessEditBoardDirective",["chessPieceService","chessPositionService","chessResources",function(t,i,s){return{restrict:"E",replace:!0,transclude:!1,scope:{},template:'<ul class="editBoardContainer"style="list-style-type: none;">	<button ng-click="clearBoard()">clear board</button>	<li ng-repeat="(keyType, type) in types">		<ul> 			<li 				class="editsquare" 				style="display:inline-block;" 				ng-repeat="(keyColor, color) in colors" 			>            	<img 					ng-src="{{imgSource(type, color)}}" 					draggable="true" 					chess-draggable-piece-directive 					type="{{keyType}}" 					color="{{keyColor}}" 				/> 			</li>		</ul> 	</li>	<li class="trash" chess-droppable-trash>		<img src="{{imgTrash()}}" />	</li></div>',link:function(e){e.types=t.types,e.type="KING",e.colors=t.colors,e.imgSource=function(t,i){return s.getPieceImage(t,i)},e.imgTrash=function(){return s.getTrash()},e.clearBoard=function(){i.clearPosition()}}}}]),angular.module("chess.directives").directive("chessSquareDirective",["chessResources",function(t){return{require:"^chessBoardDirective",replace:!0,transclude:!1,scope:{x:"@",y:"@",piece:"@?",reverse:"@"},template:' <div 	ng-class="cssClasses()"  > 	<img ng-if="!isEmpty" ng-src="{{imgSource()}}" draggable="{{isMovable()}}"></img> </div>',controller:["$scope",function(t){this.getScope=function(){return t}}],link:function(i,s,e,r){var o=function(){i.content={x:parseInt(i.x),y:parseInt(i.y),piece:void 0!==i.piece&&""!==i.piece?JSON.parse(i.piece):void 0},i.isEmpty=void 0===i.content.piece};o(),i.$watch("piece",function(){o()}),i.cssClasses=function(){var t=!0,s=(i.content.x+i.content.y)%2===0;return whiteSquare=!s,firstOfLine=0===i.content.x,reverse="true"===i.reverse,highlightSquareEmpty=i.content.highlight&&i.isEmpty,highlightSquareFilled=i.content.highlight&&!i.isEmpty,{square:t,blackSquare:s,whiteSquare:whiteSquare,firstOfLine:firstOfLine,reverse:reverse,highlightSquareEmpty:highlightSquareEmpty,highlightSquareFilled:highlightSquareFilled}},i.imgSource=function(){return i.isEmpty?void 0:t.getPieceImage(i.content.piece.name,i.content.piece.color)},i.getImage=function(){return i.isEmpty?void 0:s.find("img")},i.isMovable=function(){return r.isMovable(i)},r.registerSquareScope(i)}}}]),angular.module("chess.directives").directive("chessSquareMove",["$log","chessDragDropMove","chessClickMove","chessConstants",function(t,i,s,e){return{require:["chessSquareDirective","^chessBoardDirective"],restrict:"A",link:function(r,o,h,n){var a=n[0],E=n[1],c=E.getMoveMode();a.getScope().applyMoveMode=function(r){switch(r){case e.moveMode.dragndrop:s.deactivate(o,a,E),i.activate(o,a,E);break;case e.moveMode.click:i.deactivate(o,a,E),s.activate(o,a,E);break;default:t.error("unknown move mode: "+r)}},a.getScope().applyMoveMode(c)}}}]),angular.module("chess.controllers",[]),angular.module("chess.filters",[]),angular.module("chess.filters").filter("range",function(){return function(t,i,s){for(var e=[],r=0;i>r;r++){var o=s?i-1-r:r;e.push(o)}return e}}).filter("reverse",function(){return function(t){for(var i=[],s=0;s<t.length;s++)i.push(t[t.length-s-1]);return i}}).filter("increment",function(){return function(t,i){for(var s=[],e=0;e<t.length;e++)s.push(t[e]+i);return s}}).filter("asLetter",function(){return function(t){for(var i,s=[],e=0;e<t.length;e++)i=t[e]+3,s.push(String.fromCharCode(94+i));return s}});var MAJOR="1",MINOR="13",BUILD=6701;!function(t,i,s,e,r,o,h,n,a){function E(t){var i,s=t.length,r=this,o=0,h=r.i=r.j=0,n=r.S=[];for(s||(t=[s++]);e>o;)n[o]=o++;for(o=0;e>o;o++)n[o]=n[h=O&h+t[o%s]+(i=n[o])],n[h]=i;(r.g=function(t){for(var i,s=0,o=r.i,h=r.j,n=r.S;t--;)i=n[o=O&o+1],s=s*e+n[O&(n[o]=n[h=O&h+i])+(n[h]=i)];return r.i=o,r.j=h,s})(e)}function c(t,i){var s,e=[],r=typeof t;if(i&&"object"==r)for(s in t)try{e.push(c(t[s],i-1))}catch(o){}return e.length?e:"string"==r?t:t+"\x00"}function S(t,i){for(var s,e=t+"",r=0;r<e.length;)i[O&r]=O&(s^=19*i[O&r])+e.charCodeAt(r++);return l(i)}function _(s){try{return u?l(u.randomBytes(e)):(t.crypto.getRandomValues(s=new Uint8Array(e)),l(s))}catch(r){return[+new Date,t,(s=t.navigator)&&s.plugins,t.screen,l(i)]}}function l(t){return String.fromCharCode.apply(0,t)}var u,T=s.pow(e,r),P=s.pow(2,o),A=2*P,O=e-1,v=s["seed"+a]=function(t,o,h){var n=[];o=1==o?{entropy:!0}:o||{};var u=S(c(o.entropy?[t,l(i)]:null==t?_():t,3),n),O=new E(n);return S(l(O.S),i),(o.pass||h||function(t,i,e){return e?(s[a]=t,i):t})(function(){for(var t=O.g(r),i=T,s=0;P>t;)t=(t+s)*e,i*=e,s=O.g(1);for(;t>=A;)t/=2,i/=2,s>>>=1;return(t+s)/i},u,"global"in o?o.global:this==s)};if(S(s[a](),i),h&&h.exports){h.exports=v;try{u=require("crypto")}catch(M){}}else n&&n.amd&&n(function(){return v})}(this,[],Math,256,6,52,"object"==typeof module&&module,"function"==typeof define&&define,"random"),Math.seedrandom("Lozza rules OK");var MAX_PLY=100,MAX_MOVES=220,INFINITY=3e4,MATE=2e4,MINMATE=MATE-2*MAX_PLY,CONTEMPT=0,NULL_Y=1,NULL_N=0,INCHECK_UNKNOWN=MATE+1,TTSCORE_UNKNOWN=MATE+2,ASP_MAX=75,ASP_DELTA=3,ASP_MIN=10,EMPTY=0,UCI_FMT=0,SAN_FMT=1,WHITE=0,BLACK=8,I_WHITE=0,I_BLACK=1,M_WHITE=1,M_BLACK=-1,PIECE_MASK=7,COLOR_MASK=8,TT_EMPTY=0,TT_EXACT=1,TT_BETA=2,TT_ALPHA=3,MOVE_TO_BITS=0,MOVE_FR_BITS=8,MOVE_TOOBJ_BITS=16,MOVE_FROBJ_BITS=20,MOVE_PROMAS_BITS=29,MOVE_TO_MASK=255,MOVE_FR_MASK=65280,MOVE_TOOBJ_MASK=983040,MOVE_FROBJ_MASK=15728640,MOVE_PAWN_MASK=16777216,MOVE_EPTAKE_MASK=33554432,MOVE_EPMAKE_MASK=67108864,MOVE_CASTLE_MASK=134217728,MOVE_PROMOTE_MASK=268435456,MOVE_PROMAS_MASK=1610612736,MOVE_SPARE2_MASK=2147483648,MOVE_SPECIAL_MASK=MOVE_CASTLE_MASK|MOVE_PROMOTE_MASK|MOVE_EPTAKE_MASK|MOVE_EPMAKE_MASK,KEEPER_MASK=MOVE_CASTLE_MASK|MOVE_PROMOTE_MASK|MOVE_EPTAKE_MASK|MOVE_TOOBJ_MASK,NULL=0,PAWN=1,KNIGHT=2,BISHOP=3,ROOK=4,QUEEN=5,KING=6,EDGE=7,NO_Z=8,W_PAWN=PAWN,W_KNIGHT=KNIGHT,W_BISHOP=BISHOP,W_ROOK=ROOK,W_QUEEN=QUEEN,W_KING=KING,B_PAWN=PAWN|BLACK,B_KNIGHT=KNIGHT|BLACK,B_BISHOP=BISHOP|BLACK,B_ROOK=ROOK|BLACK,B_QUEEN=QUEEN|BLACK,B_KING=KING|BLACK,PPHASE=0,NPHASE=1,BPHASE=1,RPHASE=2,QPHASE=4,VPHASE=[0,PPHASE,NPHASE,BPHASE,RPHASE,QPHASE,0],TPHASE=16*PPHASE+4*NPHASE+4*BPHASE+4*RPHASE+2*QPHASE,EPHASE=180,A1=110,B1=111,C1=112,D1=113,E1=114,F1=115,G1=116,H1=117,A8=26,B8=27,C8=28,D8=29,E8=30,F8=31,G8=32,H8=33,MOVE_E1G1=MOVE_CASTLE_MASK|W_KING<<MOVE_FROBJ_BITS|E1<<MOVE_FR_BITS|G1,MOVE_E1C1=MOVE_CASTLE_MASK|W_KING<<MOVE_FROBJ_BITS|E1<<MOVE_FR_BITS|C1,MOVE_E8G8=MOVE_CASTLE_MASK|B_KING<<MOVE_FROBJ_BITS|E8<<MOVE_FR_BITS|G8,MOVE_E8C8=MOVE_CASTLE_MASK|B_KING<<MOVE_FROBJ_BITS|E8<<MOVE_FR_BITS|C8,WHITE_RIGHTS_KING=1,WHITE_RIGHTS_QUEEN=2,BLACK_RIGHTS_KING=4,BLACK_RIGHTS_QUEEN=8,WHITE_RIGHTS=WHITE_RIGHTS_QUEEN|WHITE_RIGHTS_KING,BLACK_RIGHTS=BLACK_RIGHTS_QUEEN|BLACK_RIGHTS_KING,MASK_RIGHTS=[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,-9,15,15,15,-13,15,15,-5,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,-3,15,15,15,-4,15,15,-2,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15],WP_OFFSET_ORTH=-12,WP_OFFSET_DIAG1=-13,WP_OFFSET_DIAG2=-11,BP_OFFSET_ORTH=12,BP_OFFSET_DIAG1=13,BP_OFFSET_DIAG2=11,KNIGHT_OFFSETS=[25,-25,23,-23,14,-14,10,-10],BISHOP_OFFSETS=[11,-11,13,-13],ROOK_OFFSETS=[1,-1,12,-12],QUEEN_OFFSETS=[11,-11,13,-13,1,-1,12,-12],KING_OFFSETS=[11,-11,13,-13,1,-1,12,-12],OFFSETS=[0,0,KNIGHT_OFFSETS,BISHOP_OFFSETS,ROOK_OFFSETS,QUEEN_OFFSETS,KING_OFFSETS],LIMITS=[0,1,1,8,8,8,1],VALUE_PAWN=100,VALUE_QUEEN=975,VALUE_VECTOR=[0,VALUE_PAWN,325,325,500,VALUE_QUEEN,1e4],RANK_VECTOR=[0,1,2,2,4,5,6],NULL_PST=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WPAWN_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,12,18,24,24,18,12,6,0,0,0,0,5,10,15,20,20,15,10,5,0,0,0,0,4,8,12,16,16,12,8,4,0,0,0,0,3,6,9,12,12,9,6,3,0,0,0,0,2,4,6,8,8,6,4,2,0,0,0,0,1,2,3,-40,-40,3,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WPAWN_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,24,36,48,48,36,24,12,0,0,0,0,10,20,30,40,40,30,20,10,0,0,0,0,8,16,24,32,32,24,16,8,0,0,0,0,6,12,18,24,24,18,12,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WKNIGHT_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-50,-40,-30,-30,-30,-30,-40,-50,0,0,0,0,-40,-20,0,0,0,0,20,-40,0,0,0,0,-30,0,10,15,15,10,0,-30,0,0,0,0,-30,5,15,20,20,15,5,-30,0,0,0,0,-30,0,15,20,20,15,0,-30,0,0,0,0,-30,5,10,15,15,10,5,-30,0,0,0,0,-40,-20,0,5,5,0,-20,-40,0,0,0,0,-50,-40,-30,-30,-30,-30,-40,-50,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WKNIGHT_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-50,-40,-30,-30,-30,-30,-40,-50,0,0,0,0,-40,-20,0,0,0,0,20,-40,0,0,0,0,-30,0,10,15,15,10,0,-30,0,0,0,0,-30,5,15,20,20,15,5,-30,0,0,0,0,-30,0,15,20,20,15,0,-30,0,0,0,0,-30,5,10,15,15,10,5,-30,0,0,0,0,-40,-20,0,5,5,0,-20,-40,0,0,0,0,-50,-40,-30,-30,-30,-30,-40,-50,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WBISHOP_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-20,-10,-10,-10,-10,-10,-10,-20,0,0,0,0,-10,0,0,0,0,0,0,-10,0,0,0,0,-10,0,5,10,10,5,0,-10,0,0,0,0,-10,5,5,10,10,5,5,-10,0,0,0,0,-10,0,10,10,10,10,0,-10,0,0,0,0,-10,10,10,10,10,10,10,-10,0,0,0,0,-10,5,0,0,0,0,5,-10,0,0,0,0,-20,-10,-10,-10,-10,-10,-10,-20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WBISHOP_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-20,-10,-10,-10,-10,-10,-10,-20,0,0,0,0,-10,0,0,0,0,0,0,-10,0,0,0,0,-10,0,5,10,10,5,0,-10,0,0,0,0,-10,5,5,10,10,5,5,-10,0,0,0,0,-10,0,10,10,10,10,0,-10,0,0,0,0,-10,10,10,10,10,10,10,-10,0,0,0,0,-10,5,0,0,0,0,5,-10,0,0,0,0,-20,-10,-10,-10,-10,-10,-10,-20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WROOK_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,10,10,10,10,10,10,5,0,0,0,0,-5,0,0,0,0,0,0,-5,0,0,0,0,-5,0,0,0,0,0,0,-5,0,0,0,0,-5,0,0,0,0,0,0,-5,0,0,0,0,-5,0,0,0,0,0,0,-5,0,0,0,0,-5,0,0,0,0,0,0,-5,0,0,0,0,0,0,0,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WROOK_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,10,10,10,10,10,10,5,0,0,0,0,-5,0,0,0,0,0,0,-5,0,0,0,0,-5,0,0,0,0,0,0,-5,0,0,0,0,-5,0,0,0,0,0,0,-5,0,0,0,0,-5,0,0,0,0,0,0,-5,0,0,0,0,-5,0,0,0,0,0,0,-5,0,0,0,0,0,0,0,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WQUEEN_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-20,-10,-10,-5,-5,-10,-10,-20,0,0,0,0,-10,0,0,0,0,0,0,-10,0,0,0,0,-10,0,5,5,5,5,0,-10,0,0,0,0,-5,0,5,5,5,5,0,-5,0,0,0,0,0,0,5,5,5,5,0,-5,0,0,0,0,-10,5,5,5,5,5,0,-10,0,0,0,0,-10,0,5,0,0,0,0,-10,0,0,0,0,-20,-10,-10,-5,-5,-10,-10,-20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WQUEEN_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-20,-10,-10,-5,-5,-10,-10,-20,0,0,0,0,-10,0,0,0,0,0,0,-10,0,0,0,0,-10,0,5,5,5,5,0,-10,0,0,0,0,-5,0,5,5,5,5,0,-5,0,0,0,0,0,0,5,5,5,5,0,-5,0,0,0,0,-10,5,5,5,5,5,0,-10,0,0,0,0,-10,0,5,0,0,0,0,-10,0,0,0,0,-20,-10,-10,-5,-5,-10,-10,-20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WKING_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-30,-40,-40,-50,-50,-40,-40,-30,0,0,0,0,-30,-40,-40,-50,-50,-40,-40,-30,0,0,0,0,-30,-40,-40,-50,-50,-40,-40,-30,0,0,0,0,-30,-40,-40,-50,-50,-40,-40,-30,0,0,0,0,-20,-30,-30,-40,-40,-30,-30,-20,0,0,0,0,-10,-20,-20,-20,-20,-20,-20,-10,0,0,0,0,20,20,0,0,0,0,20,20,0,0,0,0,20,30,10,0,0,10,30,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WKING_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-50,-40,-30,-20,-20,-30,-40,-50,0,0,0,0,-30,-20,-10,0,0,-10,-20,-30,0,0,0,0,-30,-10,20,30,30,20,-10,-30,0,0,0,0,-30,-10,30,40,40,30,-10,-30,0,0,0,0,-30,-10,30,40,40,30,-10,-30,0,0,0,0,-30,-10,20,30,30,20,-10,-30,0,0,0,0,-30,-30,0,0,0,0,-30,-30,0,0,0,0,-50,-30,-30,-30,-30,-30,-30,-50,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WPASSED_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,20,20,20,20,20,20,20,20,0,0,0,0,20,20,20,20,20,20,20,20,0,0,0,0,20,20,20,20,20,20,20,20,0,0,0,0,20,20,20,20,20,20,20,20,0,0,0,0,20,20,20,20,20,20,20,20,0,0,0,0,20,20,20,20,20,20,20,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WPASSED_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,99,99,99,99,99,99,99,99,0,0,0,0,66,66,66,66,66,66,66,66,0,0,0,0,30,30,30,30,30,30,30,30,0,0,0,0,30,30,30,30,30,30,30,30,0,0,0,0,30,30,30,30,30,30,30,30,0,0,0,0,30,30,30,30,30,30,30,30,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WDOUBLED_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,10,10,10,10,10,10,10,0,0,0,0,10,10,10,10,10,10,10,10,0,0,0,0,10,10,10,10,10,10,10,10,0,0,0,0,10,10,10,10,10,10,10,10,0,0,0,0,10,10,10,10,10,10,10,10,0,0,0,0,10,10,10,10,10,10,10,10,0,0,0,0,10,10,10,10,10,10,10,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WDOUBLED_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,10,10,10,10,10,10,10,0,0,0,0,10,10,10,10,10,10,10,10,0,0,0,0,10,10,10,10,10,10,10,10,0,0,0,0,10,10,10,10,10,10,10,10,0,0,0,0,10,10,10,10,10,10,10,10,0,0,0,0,10,10,10,10,10,10,10,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WCONNECT_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WCONNECT_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WISOLATE_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WISOLATE_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],BPAWN_PSTS=Array(144),BPAWN_PSTE=Array(144),BKNIGHT_PSTS=Array(144),BKNIGHT_PSTE=Array(144),BBISHOP_PSTS=Array(144),BBISHOP_PSTE=Array(144),BROOK_PSTS=Array(144),BROOK_PSTE=Array(144),BQUEEN_PSTS=Array(144),BQUEEN_PSTE=Array(144),BKING_PSTS=Array(144),BKING_PSTE=Array(144),BPASSED_PSTS=Array(144),BPASSED_PSTE=Array(144),BDOUBLED_PSTS=Array(144),BDOUBLED_PSTE=Array(144),BCONNECT_PSTS=Array(144),BCONNECT_PSTE=Array(144),BISOLATE_PSTS=Array(144),BISOLATE_PSTE=Array(144);_pst2Black(WPAWN_PSTS,BPAWN_PSTS),_pst2Black(WPAWN_PSTE,BPAWN_PSTE),_pst2Black(WKNIGHT_PSTS,BKNIGHT_PSTS),_pst2Black(WKNIGHT_PSTE,BKNIGHT_PSTE),_pst2Black(WBISHOP_PSTS,BBISHOP_PSTS),_pst2Black(WBISHOP_PSTE,BBISHOP_PSTE),_pst2Black(WROOK_PSTS,BROOK_PSTS),_pst2Black(WROOK_PSTE,BROOK_PSTE),_pst2Black(WQUEEN_PSTS,BQUEEN_PSTS),_pst2Black(WQUEEN_PSTE,BQUEEN_PSTE),_pst2Black(WKING_PSTS,BKING_PSTS),_pst2Black(WKING_PSTE,BKING_PSTE);var WS_PST=[NULL_PST,WPAWN_PSTS,WKNIGHT_PSTS,WBISHOP_PSTS,WROOK_PSTS,WQUEEN_PSTS,WKING_PSTS],WE_PST=[NULL_PST,WPAWN_PSTE,WKNIGHT_PSTE,WBISHOP_PSTE,WROOK_PSTE,WQUEEN_PSTE,WKING_PSTE],WM_PST=[NULL_PST,WPAWN_PSTE,WKNIGHT_PSTE,WBISHOP_PSTE,WROOK_PSTE,WQUEEN_PSTE,WKING_PSTE],BS_PST=[NULL_PST,BPAWN_PSTS,BKNIGHT_PSTS,BBISHOP_PSTS,BROOK_PSTS,BQUEEN_PSTS,BKING_PSTS],BE_PST=[NULL_PST,BPAWN_PSTE,BKNIGHT_PSTE,BBISHOP_PSTE,BROOK_PSTE,BQUEEN_PSTE,BKING_PSTE],BM_PST=[NULL_PST,BPAWN_PSTE,BKNIGHT_PSTE,BBISHOP_PSTE,BROOK_PSTE,BQUEEN_PSTE,BKING_PSTE];_pst2Black(WPASSED_PSTS,BPASSED_PSTS),_pst2Black(WPASSED_PSTE,BPASSED_PSTE),_pst2Black(WDOUBLED_PSTS,BDOUBLED_PSTS),_pst2Black(WDOUBLED_PSTE,BDOUBLED_PSTE),_pst2Black(WCONNECT_PSTS,BCONNECT_PSTS),_pst2Black(WCONNECT_PSTE,BCONNECT_PSTE),_pst2Black(WISOLATE_PSTS,BISOLATE_PSTS),_pst2Black(WISOLATE_PSTE,BISOLATE_PSTE);var B88=[26,27,28,29,30,31,32,33,38,39,40,41,42,43,44,45,50,51,52,53,54,55,56,57,62,63,64,65,66,67,68,69,74,75,76,77,78,79,80,81,86,87,88,89,90,91,92,93,98,99,100,101,102,103,104,105,110,111,112,113,114,115,116,117],COORDS=["??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","a8","b8","c8","d8","e8","f8","g8","h8","??","??","??","??","a7","b7","c7","d7","e7","f7","g7","h7","??","??","??","??","a6","b6","c6","d6","e6","f6","g6","h6","??","??","??","??","a5","b5","c5","d5","e5","f5","g5","h5","??","??","??","??","a4","b4","c4","d4","e4","f4","g4","h4","??","??","??","??","a3","b3","c3","d3","e3","f3","g3","h3","??","??","??","??","a2","b2","c2","d2","e2","f2","g2","h2","??","??","??","??","a1","b1","c1","d1","e1","f1","g1","h1","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??"],NAMES=["-","P","N","B","R","Q","K","-"],PROMOTES=["n","b","r","q"],RANK=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,8,8,8,8,8,8,8,0,0,0,0,7,7,7,7,7,7,7,7,0,0,0,0,6,6,6,6,6,6,6,6,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0,3,3,3,3,3,3,3,3,0,0,0,0,2,2,2,2,2,2,2,2,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],FILE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],MAP=[];MAP.p=B_PAWN,MAP.n=B_KNIGHT,MAP.b=B_BISHOP,MAP.r=B_ROOK,MAP.q=B_QUEEN,MAP.k=B_KING,MAP.P=W_PAWN,MAP.N=W_KNIGHT,MAP.B=W_BISHOP,MAP.R=W_ROOK,MAP.Q=W_QUEEN,MAP.K=W_KING;var UMAP=[];UMAP[B_PAWN]="p",UMAP[B_KNIGHT]="n",UMAP[B_BISHOP]="b",UMAP[B_ROOK]="r",UMAP[B_QUEEN]="q",UMAP[B_KING]="k",UMAP[W_PAWN]="P",UMAP[W_KNIGHT]="N",UMAP[W_BISHOP]="B",UMAP[W_ROOK]="R",UMAP[W_QUEEN]="Q",UMAP[W_KING]="K",lozChess.prototype.init=function(){for(var t=0;t<this.nodes.length;t++)this.nodes[t].init();this.board.init(),this.stats.init()},lozChess.prototype.newGameInit=function(){this.board.ttInit()},lozChess.prototype.position=function(){this.init();var t=this.board.position();return t},lozChess.prototype.go=function(){var t=this.board,i=this.uci.spec,s=0;if(i.depth<=0&&(i.depth=MAX_PLY),i.moveTime>0&&(this.stats.moveTime=i.moveTime),i.maxNodes>0&&(this.stats.maxNodes=i.maxNodes),0==i.moveTime){if(i.movesToGo>0)var e=i.movesToGo;else var e=20;s=t.turn==WHITE?i.wTime+e*i.wInc:i.bTime+e*i.bInc,s>0&&(this.stats.moveTime=Math.floor(s/e))}for(var r=-INFINITY,o=INFINITY,h=ASP_MAX,n=1,a=i.depth,E="",c=0,S="";a>=n&&(this.stats.ply=n,c=this.search(this.rootNode,n,t.turn,r,o),!this.stats.timeOut);)if(r>=c||c>=o)this.uci.tuning||(c>=o?this.uci.send("info string BETA",n,c,">=",o):this.uci.send("info string ALPHA",n,c,"<=",r)),r=-INFINITY,o=INFINITY,h=10*ASP_MAX;else{if(Math.abs(c)>=MINMATE&&Math.abs(c)<=MATE)break;r=c-h,o=c+h,h-=ASP_DELTA,ASP_MIN>h&&(h=ASP_MIN),n+=1}this.stats.update(),this.stats.stop(),t.makeMove(this.rootNode,this.stats.bestMove),E=t.formatMove(this.stats.bestMove,UCI_FMT),S=t.isEnd(~t.turn&COLOR_MASK),this.uci.tuning?S?this.uci.send("end",S):this.uci.send("bestmove",E):(i.txfen?this.uci.send("bestmove",E,"txfen",t.fen()):this.uci.send("bestmove",E),i.validate&&S&&this.uci.send("end",S)),this.uci.debug("phase",t.gPhase,"whis",t.wHistory[0][0],"bhis",t.bHistory[0][0]),this.uci.debug(i.board+" "+i.rights+" "+i.ep),this.uci.debug(i.depth+"p","|",this.stats.nodesMega+"Mn","|",this.stats.timeSec+"s","|",E,"|",t.formatMove(this.stats.bestMove,SAN_FMT))},lozChess.prototype.search=function(t,i,s,e,r){if(!t.childNode)return this.uci.debug("S DEPTH"),void(this.stats.timeOut=1);var o=this.board,h=~s&COLOR_MASK,n=e,a=0,E=0,c=0,S=0,_=-INFINITY,l=o.isKingAttacked(h),u=0,T=0,P=0,A=-MINMATE>=e&&e>=-MATE||e>=MINMATE&&MATE>=e,O=-MINMATE>=r&&r>=-MATE||r>=MINMATE&&MATE>=r,v=0,M=!l&&i>=2&&!O,p=!1;for(t.cache(),o.ttGet(t,i,e,r),o.genMoves(t,s);E=t.getNextMove();)if(o.makeMove(t,E),E!=t.hashMove&&o.isKingAttacked(h))o.unmakeMove(t,E),t.uncache();else{if(a++,!this.uci.tuning&&this.stats.splits>3&&this.uci.send("info currmove "+o.formatMove(E,SAN_FMT)+" currmovenumber "+a),P=o.isKingAttacked(s),p=!(A||E&KEEPER_MASK||P),t.base<BASE_LMR&&(v+=1),T=0,u=0,l&&(T=1),!T&&M&&p&&v>5&&(u=i>=8?i>>2:1),1==a?S=-this.alphabeta(t.childNode,i+T-1,h,-r,-e,NULL_Y,P):(S=-this.alphabeta(t.childNode,i+T-u-1,h,-e-1,-e,NULL_Y,P),!this.stats.timeOut&&S>e&&(S=-this.alphabeta(t.childNode,i+T-1,h,-r,-e,NULL_Y,P))),o.unmakeMove(t,E),t.uncache(),this.stats.timeOut)return;if(S>_){if(S>e){if(S>=r)return t.addKiller(S,E),o.ttPut(TT_BETA,i,S,E,t.ply),o.addHistory(i,E),S;e=S,A=-MINMATE>=e&&e>=-MATE||e>=MINMATE&&MATE>=e,o.ttPut(TT_ALPHA,i,S,E,t.ply),o.addHistory(i,E),this.stats.bestMove=E;var d=Math.abs(S),f="cp",g=S,I=o.getPVStr(t),N=o.formatMove(E,SAN_FMT);if(d>=MINMATE&&MATE>=d){var f="mate",g=Math.floor((MATE-d)/2);0>S&&(g=-g)}this.uci.tuning||this.uci.send("info depth",this.stats.ply,"seldepth",this.stats.selDepth,"score",f,g,"pv",I),o.ttGetMove(t)||this.uci.debug("TT AWOL FOR",N),I||this.uci.debug("NULL PV FOR",N),0!=I.indexOf(N)&&this.uci.debug("WRONG PV FOR",N),this.uci.tuning||this.uci.send("info hashfull",Math.round(1e3*o.hashUsed/o.ttSize))}_=S,c=E}}return 0==a&&this.uci.debug("INVALID"),1==a&&(this.stats.timeOut=1),_>n?(o.ttPut(TT_EXACT,i,_,c,t.ply),_):(o.ttPut(TT_ALPHA,i,n,c,t.ply),n)},lozChess.prototype.alphabeta=function(t,i,s,e,r,o,h){if(t.childNode||(this.uci.debug("AB DEPTH"),this.stats.timeOut=1),!(i>2||this.stats.timeOut)||(this.stats.lazyUpdate(),!this.stats.timeOut)){t.ply>this.stats.selDepth&&(this.stats.selDepth=t.ply);var n=this.board,a=~s&COLOR_MASK,E=0,c=MATE-t.ply;if(r>c&&(r=c,e>=c))return c;var c=-MATE+t.ply;if(c>e&&(e=c,c>=r))return c;if(n.repHi-n.repLo>100)return CONTEMPT;for(var S=n.repHi-5;S>=n.repLo;S-=2)if(n.repLoHash[S]==n.loHash&&n.repHiHash[S]==n.hiHash)return CONTEMPT;if(0>=i)return E=this.qSearch(t,i-1,s,e,r);if(E=n.ttGet(t,i,e,r),E!=TTSCORE_UNKNOWN)return E;h==INCHECK_UNKNOWN&&(h=n.isKingAttacked(a));var _=-MINMATE>=r&&r>=-MATE||r>=MINMATE&&MATE>=r,l=r!=e+1,u=n.evaluate(s),T=0,P=0,A=s==WHITE&&1==n.wCount||s==BLACK&&1==n.bCount;if(!h&&!_&&!l&&3>=i&&(E=u-70*i,E>=r))return E;if(t.cache(),T=3,!l&&!A&&u>r&&!_&&o==NULL_Y&&!h){if(n.loHash^=n.loEP[n.ep],n.hiHash^=n.hiEP[n.ep],n.ep=0,n.loHash^=n.loEP[n.ep],n.hiHash^=n.hiEP[n.ep],n.loHash^=n.loTurn,n.hiHash^=n.hiTurn,E=-this.alphabeta(t.childNode,i-T-1,a,-r,-r+1,NULL_N,INCHECK_UNKNOWN),t.uncache(),this.stats.timeOut)return;if(E>=r)return E}T=0;var O=-INFINITY,v=0,M=0,p=e,d=-MINMATE>=e&&e>=-MATE||e>=MINMATE&&MATE>=e,f=!h&&5>=i&&e>u+10+70*i,g=!h&&3>=i&&!_,I=!h&&i>=2&&!_,N=0,B=0,K=0,H=!1;for(!t.hashMove&&l&&i>3&&(this.alphabeta(t.childNode,i-2,s,e,r,NULL_N,h),n.ttGet(t,0,e,r)),n.genMoves(t,s);v=t.getNextMove();)if(n.makeMove(t,v),v!=t.hashMove&&n.isKingAttacked(a))n.unmakeMove(t,v),t.uncache();else if(N++,t.base<BASE_LMR&&(B+=1),K=n.isKingAttacked(s),H=!(d||v&KEEPER_MASK||K),f&&H&&N>1)n.unmakeMove(t,v),t.uncache();else if(g&&H&&B>10*i)n.unmakeMove(t,v),t.uncache();else{if(P=0,T=0,h&&(P=1),!P&&I&&H&&B>5&&(T=i>=8?i>>2:1),l?1==N?E=-this.alphabeta(t.childNode,i+P-1,a,-r,-e,NULL_Y,K):(E=-this.alphabeta(t.childNode,i+P-T-1,a,-e-1,-e,NULL_Y,K),!this.stats.timeOut&&E>e&&(E=-this.alphabeta(t.childNode,i+P-1,a,-r,-e,NULL_Y,K))):(E=-this.alphabeta(t.childNode,i+P-T-1,a,-r,-e,NULL_Y,K),T&&!this.stats.timeOut&&E>e&&(E=-this.alphabeta(t.childNode,i+P-1,a,-r,-e,NULL_Y,K))),n.unmakeMove(t,v),t.uncache(),this.stats.timeOut)return;if(E>O){if(E>e){if(E>=r)return t.addKiller(E,v),n.ttPut(TT_BETA,i,E,v,t.ply),n.addHistory(i,v),E;
n.ttPut(TT_ALPHA,i,E,v,t.ply),n.addHistory(i,v),e=E,d=-MINMATE>=e&&e>=-MATE||e>=MINMATE&&MATE>=e}O=E,M=v}}return 0==N?h?-MATE+t.ply:CONTEMPT:O>p?(n.ttPut(TT_EXACT,i,O,M,t.ply),O):(n.ttPut(TT_ALPHA,i,p,M,t.ply),p)}},lozChess.prototype.qSearch=function(t,i,s,e,r){var o=this.board,h=o.evaluate(s),n=o.gPhase;if(!t.childNode)return this.uci.debug("Q DEPTH"),h;if(t.ply>this.stats.selDepth&&(this.stats.selDepth=t.ply),h>=r)return r;if(e>h+VALUE_QUEEN)return e;var a=~s&COLOR_MASK,E=0;for(e=h>e?h:e,t.cache(),o.genQMoves(t,s);E=t.getNextMove();)if(o.makeMove(t,E),o.isKingAttacked(a))o.unmakeMove(t,E),t.uncache();else if(EPHASE>=n&&!(E&MOVE_PROMOTE_MASK)&&h+200+VALUE_VECTOR[(E&MOVE_TOOBJ_MASK)>>>MOVE_TOOBJ_BITS&PIECE_MASK]<e)o.unmakeMove(t,E),t.uncache();else{var c=-this.qSearch(t.childNode,i-1,a,-r,-e);if(o.unmakeMove(t,E),t.uncache(),c>e){if(c>=r)return r;e=c}}return e},lozChess.prototype.perft=function(){var t=this.uci.spec;this.stats.ply=t.depth;var i=this.perftSearch(this.rootNode,t.depth,this.board.turn,t.inner);this.stats.update();var s=i-t.moves;if(0==s)var e="";else var e="ERROR "+s;this.uci.send("info string",t.id,t.depth,i,t.moves,e)},lozChess.prototype.perftSearch=function(t,i,s,e){if(this.stats.nodes++,0==i)return 1;var r=this.board,o=0,h=0,n=0,a=~s&COLOR_MASK,E=0;for(t.cache(),r.genMoves(t,s);n=t.getNextMove();)if(r.makeMove(t,n),r.isKingAttacked(a))r.unmakeMove(t,n),t.uncache();else{E++;var o=this.perftSearch(t.childNode,i-1,a);if(h+=o,r.unmakeMove(t,n),t.uncache(),t.root){var c=r.formatMove(n,SAN_FMT);this.uci.send("info currmove "+c+" currmovenumber "+E),e&&this.uci.send("info string",c,o)}}return i>2&&this.stats.lazyUpdate(),h},lozBoard.prototype.init=function(){for(var t=0;t<this.b.length;t++)this.b[t]=EDGE;for(var t=0;t<B88.length;t++)this.b[B88[t]]=NULL;for(var t=0;t<this.z.length;t++)this.z[t]=NO_Z;this.loHash=0,this.hiHash=0,this.ploHash=0,this.phiHash=0,this.repLo=0,this.repHi=0,this.phase=TPHASE,this.gPhase=0;for(var t=0;t<this.wCounts.length;t++)this.wCounts[t]=0;for(var t=0;t<this.bCounts.length;t++)this.bCounts[t]=0;this.wCount=0,this.bCount=0;for(var t=0;t<this.wList.length;t++)this.wList[t]=EMPTY;for(var t=0;t<this.bList.length;t++)this.bList[t]=EMPTY;this.firstBP=0,this.firstWP=0,this.mobilityS=0,this.mobilityE=0},lozBoard.prototype.position=function(){var t=this.lozza.uci.spec;"w"==t.turn?this.turn=WHITE:(this.turn=BLACK,this.loHash^=this.loTurn,this.hiHash^=this.hiTurn),this.rights=0;for(var i=0;i<t.rights.length;i++){var s=t.rights.charAt(i);"K"==s&&(this.rights|=WHITE_RIGHTS_KING),"Q"==s&&(this.rights|=WHITE_RIGHTS_QUEEN),"k"==s&&(this.rights|=BLACK_RIGHTS_KING),"q"==s&&(this.rights|=BLACK_RIGHTS_QUEEN)}this.loHash^=this.loRights[this.rights],this.hiHash^=this.hiRights[this.rights],this.phase=TPHASE;for(var e=0,r=0,o=0,h=0;h<t.board.length;h++){for(var s=t.board.charAt(h),n=parseInt(s);this.b[e]==EDGE;)e++;if(isNaN(n)){if("/"!=s){var a=MAP[s],E=a&PIECE_MASK,c=a&COLOR_MASK;c==WHITE?(this.wList[r]=e,this.b[e]=a,this.z[e]=r,r++,this.wCounts[E]++,this.wCount++):(this.bList[o]=e,this.b[e]=a,this.z[e]=o,o++,this.bCounts[E]++,this.bCount++),this.loHash^=this.loPieces[c>>>3][E-1][e],this.hiHash^=this.hiPieces[c>>>3][E-1][e],E==PAWN&&(this.ploHash^=this.loPieces[c>>>3][0][e],this.phiHash^=this.hiPieces[c>>>3][0][e]),this.phase-=VPHASE[E],e++}}else for(var S=0;n>S;S++)this.b[e]=NULL,e++}this.ep=2==t.ep.length?COORDS.indexOf(t.ep):0,this.loHash^=this.loEP[this.ep],this.hiHash^=this.hiEP[this.ep],this.runningEvalS=0,this.runningEvalE=0;for(var _=0,l=0;l<this.wCount;)if(e=this.wList[_]){var E=this.b[e]&PIECE_MASK;this.runningEvalS+=VALUE_VECTOR[E],this.runningEvalS+=WS_PST[E][e],this.runningEvalE+=VALUE_VECTOR[E],this.runningEvalE+=WE_PST[E][e],l++,_++}else _++;for(var _=0,l=0;l<this.bCount;)if(e=this.bList[_]){var E=this.b[e]&PIECE_MASK;this.runningEvalS-=VALUE_VECTOR[E],this.runningEvalS-=BS_PST[E][e],this.runningEvalE-=VALUE_VECTOR[E],this.runningEvalE-=BE_PST[E][e],l++,_++}else _++;this.compact();for(var i=0;i<t.moves.length;i++){if(!this.playMove(t.moves[i]))return 0;i==t.moves.length-1&&(t.fen=this.fen())}this.compact();for(var i=0;7>i;i++)for(var h=0;144>h;h++)this.wHistory[i][h]=0;for(var i=0;7>i;i++)for(var h=0;144>h;h++)this.bHistory[i][h]=0;return 1},lozBoard.prototype.compact=function(){for(var t=[],i=0;16>i;i++)this.wList[i]&&t.push(this.wList[i]);t.sort(function(t,i){return lozza.board.b[i]-lozza.board.b[t]});for(var i=0;16>i;i++)i<t.length?(this.wList[i]=t[i],this.z[t[i]]=i):this.wList[i]=EMPTY;this.firstWP=0;for(var i=0;16>i;i++)if(this.b[this.wList[i]]==W_PAWN){this.firstWP=i;break}this.b[this.wList[0]]!=W_KING&&console.log("WHITE INDEX ERR");for(var t=[],i=0;16>i;i++)this.bList[i]&&t.push(this.bList[i]);t.sort(function(t,i){return lozza.board.b[i]-lozza.board.b[t]});for(var i=0;16>i;i++)i<t.length?(this.bList[i]=t[i],this.z[t[i]]=i):this.bList[i]=EMPTY;this.firstBP=0;for(var i=0;16>i;i++)if(this.b[this.bList[i]]==B_PAWN){this.firstBP=i;break}this.b[this.bList[0]]!=B_KING&&console.log("BLACK INDEX ERR")},lozBoard.prototype.genMoves=function(t,i){t.numMoves=0,t.sortedIndex=0;var s=this.b;if(i==WHITE){var e=WP_OFFSET_ORTH,r=WP_OFFSET_DIAG1,o=WP_OFFSET_DIAG2,h=2,n=8,a=this.rights&WHITE_RIGHTS,E=this.wList,c=this.wCount;a&&(a&WHITE_RIGHTS_KING&&s[F1]==NULL&&s[G1]==NULL&&!this.isAttacked(F1,BLACK)&&!this.isAttacked(E1,BLACK)&&t.addMove(MOVE_E1G1),a&WHITE_RIGHTS_QUEEN&&s[B1]==NULL&&s[C1]==NULL&&s[D1]==NULL&&!this.isAttacked(D1,BLACK)&&!this.isAttacked(E1,BLACK)&&t.addMove(MOVE_E1C1))}else{var e=BP_OFFSET_ORTH,r=BP_OFFSET_DIAG1,o=BP_OFFSET_DIAG2,h=7,n=1,a=this.rights&BLACK_RIGHTS,E=this.bList,c=this.bCount;a&&(a&BLACK_RIGHTS_KING&&s[F8]==NULL&&s[G8]==NULL&&!this.isAttacked(F8,WHITE)&&!this.isAttacked(E8,WHITE)&&t.addMove(MOVE_E8G8),a&BLACK_RIGHTS_QUEEN&&s[B8]==NULL&&s[C8]==NULL&&s[D8]==NULL&&!this.isAttacked(D8,WHITE)&&!this.isAttacked(E8,WHITE)&&t.addMove(MOVE_E8C8))}for(var S=0,_=0;c>_;){var l=E[S];if(l){var u=this.b[l],T=u&PIECE_MASK,P=u<<MOVE_FROBJ_BITS|l<<MOVE_FR_BITS;if(T==PAWN){P|=MOVE_PAWN_MASK;var A=l+e,O=s[A];O==NULL&&(RANK[A]==n?t.addPromotion(MOVE_PROMOTE_MASK|P|O<<MOVE_TOOBJ_BITS|A):(t.addMove(P|O<<MOVE_TOOBJ_BITS|A),RANK[l]==h&&(A+=e,O=s[A],O==NULL&&t.addMove(MOVE_EPMAKE_MASK|P|O<<MOVE_TOOBJ_BITS|A))));var A=l+r,O=s[A];O!=NULL&&O!=EDGE&&(O&COLOR_MASK)!=i?RANK[A]==n?t.addPromotion(MOVE_PROMOTE_MASK|P|O<<MOVE_TOOBJ_BITS|A):t.addMove(P|O<<MOVE_TOOBJ_BITS|A):O==NULL&&A==this.ep&&t.addMove(MOVE_EPTAKE_MASK|P|O<<MOVE_TOOBJ_BITS|A);var A=l+o,O=s[A];O!=NULL&&O!=EDGE&&(O&COLOR_MASK)!=i?RANK[A]==n?t.addPromotion(MOVE_PROMOTE_MASK|P|O<<MOVE_TOOBJ_BITS|A):t.addMove(P|O<<MOVE_TOOBJ_BITS|A):O==NULL&&A==this.ep&&t.addMove(MOVE_EPTAKE_MASK|P|O<<MOVE_TOOBJ_BITS|A)}else for(var v=OFFSETS[T],M=LIMITS[T],p=0;p<v.length;p++)for(var d=v[p],f=1;M>=f;f++){var A=l+d*f,O=s[A];if(O!=NULL){if(O==EDGE)break;(O&COLOR_MASK)!=i&&t.addMove(P|O<<MOVE_TOOBJ_BITS|A);break}t.addMove(P|O<<MOVE_TOOBJ_BITS|A)}S++,_++}else S++}},lozBoard.prototype.mobility=function(t){var i=5;this.lozza.uci.tuning&&(i=this.lozza.uci.tune1);var s=0,e=0,r=this.b;if(t==WHITE)var o=this.wList,h=this.wCount-1-this.wCounts[PAWN];else var o=this.bList,h=this.bCount-1-this.bCounts[PAWN];for(var n=1,a=0;h>a;){var E=o[n++];if(E){for(var c=this.b[E]&PIECE_MASK,S=OFFSETS[c],_=LIMITS[c],l=0;l<S.length;l++)for(var u=S[l],T=1;_>=T;T++){var P=E+u*T,A=r[P];if(A!=NULL){if(A==EDGE)break;s+=i,e+=i;break}s+=i,e+=i}a++}}this.mobilityS=s,this.mobilityE=e},lozBoard.prototype.makeMove=function(t,i){var s=this.b,e=this.z,r=(i&MOVE_FR_MASK)>>>MOVE_FR_BITS,o=(i&MOVE_TO_MASK)>>>MOVE_TO_BITS,h=(i&MOVE_TOOBJ_MASK)>>>MOVE_TOOBJ_BITS,n=(i&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS,a=n&PIECE_MASK,E=n&COLOR_MASK,c=E>>>3;if(s[r]=NULL,s[o]=n,t.frZ=e[r],t.toZ=e[o],e[r]=NO_Z,e[o]=t.frZ,this.loHash^=this.loPieces[c][a-1][r],this.hiHash^=this.hiPieces[c][a-1][r],this.loHash^=this.loPieces[c][a-1][o],this.hiHash^=this.hiPieces[c][a-1][o],a==PAWN&&(this.ploHash^=this.loPieces[c][PAWN-1][r],this.phiHash^=this.hiPieces[c][PAWN-1][r],this.ploHash^=this.loPieces[c][PAWN-1][o],this.phiHash^=this.hiPieces[c][PAWN-1][o]),E==WHITE?(this.wList[t.frZ]=o,this.runningEvalS-=WS_PST[a][r],this.runningEvalS+=WS_PST[a][o],this.runningEvalE-=WE_PST[a][r],this.runningEvalE+=WE_PST[a][o]):(this.bList[t.frZ]=o,this.runningEvalS+=BS_PST[a][r],this.runningEvalS-=BS_PST[a][o],this.runningEvalE+=BE_PST[a][r],this.runningEvalE-=BE_PST[a][o]),this.rights&&(this.loHash^=this.loRights[this.rights],this.hiHash^=this.hiRights[this.rights],this.rights&=MASK_RIGHTS[r]&MASK_RIGHTS[o],this.loHash^=this.loRights[this.rights],this.hiHash^=this.hiRights[this.rights]),h){var S=h&PIECE_MASK,_=h&COLOR_MASK,l=_>>>3;this.loHash^=this.loPieces[l][S-1][o],this.hiHash^=this.hiPieces[l][S-1][o],S==PAWN&&(this.ploHash^=this.loPieces[l][PAWN-1][o],this.phiHash^=this.hiPieces[l][PAWN-1][o]),this.phase+=VPHASE[S],_==WHITE?(this.wList[t.toZ]=EMPTY,this.runningEvalS-=VALUE_VECTOR[S],this.runningEvalS-=WS_PST[S][o],this.runningEvalE-=VALUE_VECTOR[S],this.runningEvalE-=WE_PST[S][o],this.wCounts[S]--,this.wCount--):(this.bList[t.toZ]=EMPTY,this.runningEvalS+=VALUE_VECTOR[S],this.runningEvalS+=BS_PST[S][o],this.runningEvalE+=VALUE_VECTOR[S],this.runningEvalE+=BE_PST[S][o],this.bCounts[S]--,this.bCount--)}if(this.loHash^=this.loEP[this.ep],this.hiHash^=this.hiEP[this.ep],this.ep=0,this.loHash^=this.loEP[this.ep],this.hiHash^=this.hiEP[this.ep],i&MOVE_SPECIAL_MASK)if(E==WHITE){var u=o+12;if(i&MOVE_EPMAKE_MASK)this.loHash^=this.loEP[this.ep],this.hiHash^=this.hiEP[this.ep],this.ep=u,this.loHash^=this.loEP[this.ep],this.hiHash^=this.hiEP[this.ep];else if(i&MOVE_EPTAKE_MASK)s[u]=NULL,t.epZ=e[u],e[u]=NO_Z,this.bList[t.epZ]=EMPTY,this.loHash^=this.loPieces[I_BLACK][PAWN-1][u],this.hiHash^=this.hiPieces[I_BLACK][PAWN-1][u],this.ploHash^=this.loPieces[I_BLACK][PAWN-1][u],this.phiHash^=this.hiPieces[I_BLACK][PAWN-1][u],this.runningEvalS+=VALUE_PAWN,this.runningEvalS+=BS_PST[PAWN][u],this.runningEvalE+=VALUE_PAWN,this.runningEvalE+=BE_PST[PAWN][u],this.bCounts[PAWN]--,this.bCount--;else if(i&MOVE_PROMOTE_MASK){var T=((i&MOVE_PROMAS_MASK)>>>MOVE_PROMAS_BITS)+2;s[o]=WHITE|T,this.loHash^=this.loPieces[I_WHITE][PAWN-1][o],this.hiHash^=this.hiPieces[I_WHITE][PAWN-1][o],this.loHash^=this.loPieces[I_WHITE][T-1][o],this.hiHash^=this.hiPieces[I_WHITE][T-1][o],this.ploHash^=this.loPieces[0][PAWN-1][o],this.phiHash^=this.hiPieces[0][PAWN-1][o],this.runningEvalS-=VALUE_PAWN,this.runningEvalS-=WS_PST[PAWN][o],this.runningEvalE-=VALUE_PAWN,this.runningEvalE-=WE_PST[PAWN][o],this.wCounts[PAWN]--,this.runningEvalS+=VALUE_VECTOR[T],this.runningEvalS+=WS_PST[T][o],this.runningEvalE+=VALUE_VECTOR[T],this.runningEvalE+=WE_PST[T][o],this.wCounts[T]++,this.phase-=VPHASE[T]}else i==MOVE_E1G1?(s[H1]=NULL,s[F1]=W_ROOK,e[F1]=e[H1],e[H1]=NO_Z,this.wList[e[F1]]=F1,this.loHash^=this.loPieces[I_WHITE][ROOK-1][H1],this.hiHash^=this.hiPieces[I_WHITE][ROOK-1][H1],this.loHash^=this.loPieces[I_WHITE][ROOK-1][F1],this.hiHash^=this.hiPieces[I_WHITE][ROOK-1][F1],this.runningEvalS-=WS_PST[ROOK][H1],this.runningEvalS+=WS_PST[ROOK][F1],this.runningEvalE-=WE_PST[ROOK][H1],this.runningEvalE+=WE_PST[ROOK][F1]):i==MOVE_E1C1&&(s[A1]=NULL,s[D1]=W_ROOK,e[D1]=e[A1],e[A1]=NO_Z,this.wList[e[D1]]=D1,this.loHash^=this.loPieces[I_WHITE][ROOK-1][A1],this.hiHash^=this.hiPieces[I_WHITE][ROOK-1][A1],this.loHash^=this.loPieces[I_WHITE][ROOK-1][D1],this.hiHash^=this.hiPieces[I_WHITE][ROOK-1][D1],this.runningEvalS-=WS_PST[ROOK][A1],this.runningEvalS+=WS_PST[ROOK][D1],this.runningEvalE-=WE_PST[ROOK][A1],this.runningEvalE+=WE_PST[ROOK][D1])}else{var u=o-12;if(i&MOVE_EPMAKE_MASK)this.loHash^=this.loEP[this.ep],this.hiHash^=this.hiEP[this.ep],this.ep=u,this.loHash^=this.loEP[this.ep],this.hiHash^=this.hiEP[this.ep];else if(i&MOVE_EPTAKE_MASK)s[u]=NULL,t.epZ=e[u],e[u]=NO_Z,this.wList[t.epZ]=EMPTY,this.loHash^=this.loPieces[I_WHITE][PAWN-1][u],this.hiHash^=this.hiPieces[I_WHITE][PAWN-1][u],this.ploHash^=this.loPieces[I_WHITE][PAWN-1][u],this.phiHash^=this.hiPieces[I_WHITE][PAWN-1][u],this.runningEvalS-=VALUE_PAWN,this.runningEvalS-=WS_PST[PAWN][u],this.runningEvalE-=VALUE_PAWN,this.runningEvalE-=WE_PST[PAWN][u],this.wCounts[PAWN]--,this.wCount--;else if(i&MOVE_PROMOTE_MASK){var T=((i&MOVE_PROMAS_MASK)>>>MOVE_PROMAS_BITS)+2;s[o]=BLACK|T,this.loHash^=this.loPieces[I_BLACK][PAWN-1][o],this.hiHash^=this.hiPieces[I_BLACK][PAWN-1][o],this.loHash^=this.loPieces[I_BLACK][T-1][o],this.hiHash^=this.hiPieces[I_BLACK][T-1][o],this.ploHash^=this.loPieces[I_BLACK][PAWN-1][o],this.phiHash^=this.hiPieces[I_BLACK][PAWN-1][o],this.runningEvalS+=VALUE_PAWN,this.runningEvalS+=BS_PST[PAWN][o],this.runningEvalE+=VALUE_PAWN,this.runningEvalE+=BE_PST[PAWN][o],this.bCounts[PAWN]--,this.runningEvalS-=VALUE_VECTOR[T],this.runningEvalS-=BS_PST[T][o],this.runningEvalE-=VALUE_VECTOR[T],this.runningEvalE-=BE_PST[T][o],this.bCounts[T]++,this.phase-=VPHASE[T]}else i==MOVE_E8G8?(s[H8]=NULL,s[F8]=B_ROOK,e[F8]=e[H8],e[H8]=NO_Z,this.bList[e[F8]]=F8,this.loHash^=this.loPieces[I_BLACK][ROOK-1][H8],this.hiHash^=this.hiPieces[I_BLACK][ROOK-1][H8],this.loHash^=this.loPieces[I_BLACK][ROOK-1][F8],this.hiHash^=this.hiPieces[I_BLACK][ROOK-1][F8],this.runningEvalS+=BS_PST[ROOK][H8],this.runningEvalS-=BS_PST[ROOK][F8],this.runningEvalE+=BE_PST[ROOK][H8],this.runningEvalE-=BE_PST[ROOK][F8]):i==MOVE_E8C8&&(s[A8]=NULL,s[D8]=B_ROOK,e[D8]=e[A8],e[A8]=NO_Z,this.bList[e[D8]]=D8,this.loHash^=this.loPieces[I_BLACK][ROOK-1][A8],this.hiHash^=this.hiPieces[I_BLACK][ROOK-1][A8],this.loHash^=this.loPieces[I_BLACK][ROOK-1][D8],this.hiHash^=this.hiPieces[I_BLACK][ROOK-1][D8],this.runningEvalS+=BS_PST[ROOK][A8],this.runningEvalS-=BS_PST[ROOK][D8],this.runningEvalE+=BE_PST[ROOK][A8],this.runningEvalE-=BE_PST[ROOK][D8])}this.loHash^=this.loTurn,this.hiHash^=this.hiTurn,this.repLoHash[this.repHi]=this.loHash,this.repHiHash[this.repHi]=this.hiHash,this.repHi++,(i&(MOVE_SPECIAL_MASK|MOVE_TOOBJ_MASK)||a==PAWN)&&(this.repLo=this.repHi)},lozBoard.prototype.unmakeMove=function(t,i){var s=this.b,e=this.z,r=(i&MOVE_FR_MASK)>>>MOVE_FR_BITS,o=(i&MOVE_TO_MASK)>>>MOVE_TO_BITS,h=(i&MOVE_TOOBJ_MASK)>>>MOVE_TOOBJ_BITS,n=(i&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS,a=n&COLOR_MASK;if(s[r]=n,s[o]=h,e[r]=t.frZ,e[o]=t.toZ,a==WHITE?this.wList[t.frZ]=r:this.bList[t.frZ]=r,h){var E=h&PIECE_MASK,c=h&COLOR_MASK;this.phase-=VPHASE[E],c==WHITE?(this.wList[t.toZ]=o,this.wCounts[E]++,this.wCount++):(this.bList[t.toZ]=o,this.bCounts[E]++,this.bCount++)}if(i&MOVE_SPECIAL_MASK)if((n&COLOR_MASK)==WHITE){var S=o+12;if(i&MOVE_EPTAKE_MASK)s[S]=B_PAWN,e[S]=t.epZ,this.bList[t.epZ]=S,this.bCounts[PAWN]++,this.bCount++;else if(i&MOVE_PROMOTE_MASK){var _=((i&MOVE_PROMAS_MASK)>>>MOVE_PROMAS_BITS)+2;this.wCounts[PAWN]++,this.wCounts[_]--,this.phase+=VPHASE[_]}else i==MOVE_E1G1?(s[H1]=W_ROOK,s[F1]=NULL,e[H1]=e[F1],e[F1]=NO_Z,this.wList[e[H1]]=H1):i==MOVE_E1C1&&(s[A1]=W_ROOK,s[D1]=NULL,e[A1]=e[D1],e[D1]=NO_Z,this.wList[e[A1]]=A1)}else{var S=o-12;if(i&MOVE_EPTAKE_MASK)s[S]=W_PAWN,e[S]=t.epZ,this.wList[t.epZ]=S,this.wCounts[PAWN]++,this.wCount++;else if(i&MOVE_PROMOTE_MASK){var _=((i&MOVE_PROMAS_MASK)>>>MOVE_PROMAS_BITS)+2;this.bCounts[PAWN]++,this.bCounts[_]--,this.phase+=VPHASE[_]}else i==MOVE_E8G8?(s[H8]=B_ROOK,s[F8]=NULL,e[H8]=e[F8],e[F8]=NO_Z,this.bList[e[H8]]=H8):i==MOVE_E8C8&&(s[A8]=B_ROOK,s[D8]=NULL,e[A8]=e[D8],e[D8]=NO_Z,this.bList[e[A8]]=A8)}},lozBoard.prototype.genQMoves=function(t,i){t.numMoves=0,t.sortedIndex=0;var s=this.b;if(i==WHITE)var e=WP_OFFSET_DIAG1,r=WP_OFFSET_DIAG2,o=8,h=this.wList,n=this.wCount;else var e=BP_OFFSET_DIAG1,r=BP_OFFSET_DIAG2,o=1,h=this.bList,n=this.bCount;for(var a=0,E=0;n>E;){var c=h[a];if(c){var S=s[c],_=S&PIECE_MASK,l=S<<MOVE_FROBJ_BITS|c<<MOVE_FR_BITS;if(_==PAWN){l|=MOVE_PAWN_MASK;var u=c+e,T=s[u];T!=NULL&&T!=EDGE&&(T&COLOR_MASK)!=i?RANK[u]==o?t.addQPromotion(MOVE_PROMOTE_MASK|l|T<<MOVE_TOOBJ_BITS|u):t.addQMove(l|T<<MOVE_TOOBJ_BITS|u):T==NULL&&u==this.ep&&t.addQMove(MOVE_EPTAKE_MASK|l|T<<MOVE_TOOBJ_BITS|u);var u=c+r,T=s[u];T!=NULL&&T!=EDGE&&(T&COLOR_MASK)!=i?RANK[u]==o?t.addQPromotion(MOVE_PROMOTE_MASK|l|T<<MOVE_TOOBJ_BITS|u):t.addQMove(l|T<<MOVE_TOOBJ_BITS|u):T==NULL&&u==this.ep&&t.addQMove(MOVE_EPTAKE_MASK|l|T<<MOVE_TOOBJ_BITS|u)}else for(var P=OFFSETS[_],A=LIMITS[_],O=0;O<P.length;O++)for(var v=P[O],M=1;A>=M;M++){var u=c+v*M,T=s[u];if(T!=NULL){if(T==EDGE)break;(T&COLOR_MASK)!=i&&t.addQMove(l|T<<MOVE_TOOBJ_BITS|u);break}}a++,E++}else a++}},lozBoard.prototype.isKingAttacked=function(t){return this.isAttacked(t==WHITE?this.bList[0]:this.wList[0],t)},lozBoard.prototype.isAttacked=function(t,i){for(var s=this.b,e=QUEEN_OFFSETS,r=e.length,o=0,h=r;h--;)for(var n=e[h],a=1;8>=a;a++){var E=s[t+a*n];if(E!=NULL){if(E==EDGE||(E&COLOR_MASK)!=i){o++;break}var c=E&PIECE_MASK;if(c==QUEEN||3>=h&&c==BISHOP||h>3&&c==ROOK)return E;break}}var S=KNIGHT|i;if(s[t+-10]==S)return S;if(s[t+-23]==S)return S;if(s[t+-14]==S)return S;if(s[t+-25]==S)return S;if(s[t+10]==S)return S;if(s[t+23]==S)return S;if(s[t+14]==S)return S;if(s[t+25]==S)return S;if(8==o)return 0;if(i==BLACK&&s[t+WP_OFFSET_DIAG1]==B_PAWN)return B_PAWN;if(i==BLACK&&s[t+WP_OFFSET_DIAG2]==B_PAWN)return B_PAWN;if(i==WHITE&&s[t+BP_OFFSET_DIAG1]==W_PAWN)return W_PAWN;if(i==WHITE&&s[t+BP_OFFSET_DIAG2]==W_PAWN)return W_PAWN;var S=KING|i;return s[t+-11]==S?S:s[t+-13]==S?S:s[t+-12]==S?S:s[t+-1]==S?S:s[t+11]==S?S:s[t+13]==S?S:s[t+12]==S?S:s[t+1]==S?S:0},lozBoard.prototype.formatMove=function(t,i){if(0==t)return"NULL";{var s=(t&MOVE_FR_MASK)>>>MOVE_FR_BITS,e=(t&MOVE_TO_MASK)>>>MOVE_TO_BITS,r=(t&MOVE_TOOBJ_MASK)>>>MOVE_TOOBJ_BITS,o=(t&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS,h=COORDS[s],n=COORDS[e],a=o&PIECE_MASK,E=NAMES[a],c=r&PIECE_MASK;NAMES[c]}if(t&MOVE_PROMOTE_MASK)var S=PROMOTES[(t&MOVE_PROMAS_MASK)>>>MOVE_PROMAS_BITS];else var S="";return i==UCI_FMT?h+n+S:r!=NULL?a==PAWN?h+"x"+n+S:E+"x"+n:a==PAWN?n+S:t==MOVE_E1G1||t==MOVE_E8G8?"0-0":t==MOVE_E1C1||t==MOVE_E8C8?"0-0-0":E+n},lozBoard.prototype.evaluate=function(t){this.lozza.stats.nodes++;var i=this.lozza.uci;this.verbose&&(this.tab='<table style="max-width: 400px;" class="table">',this.tab+="<tr><th>What</th><th>Mid</th><th>End</th><th>&nbsp;</th></tr>");var s=this.runningEvalS,e=this.runningEvalE,r=this.phase;0>r&&(r=0),r>TPHASE&&(r=TPHASE),this.gPhase=0|Math.round((r<<8)/TPHASE),this.verbose&&(this.etrace("phase="+this.gPhase,"","",""),this.etrace("running material",s,e,""));{var o=this.wCount+this.bCount,h=this.wCounts[BISHOP],n=this.wCounts[KNIGHT],a=this.wCounts[PAWN],E=this.bCounts[BISHOP],c=this.bCounts[KNIGHT],S=this.bCounts[PAWN],_=this.wList[0],l=(RANK[_],FILE[_],this.bList[0]);RANK[l],FILE[l]}if(!this.verbose){if(2==o)return CONTEMPT;if(3==o&&(n||h||c||E))return CONTEMPT;if(4==o&&(n||h)&&(c||E))return CONTEMPT}var u=0,T=0,P=this.ploHash&this.pttMask;if(this.pttType[P]==TT_EXACT&&this.pttLo[P]==this.ploHash&&this.pttHi[P]==this.phiHash)u=this.pttScoreS[P],T=this.pttScoreE[P];else{this.wPawns[0]=9,this.wPawns[1]=9,this.wPawns[2]=9,this.wPawns[3]=9,this.wPawns[4]=9,this.wPawns[5]=9,this.wPawns[6]=9,this.wPawns[7]=9,this.wPawns[8]=9,this.wPawns[9]=9;for(var A=this.firstWP,O=0;a>O;)if(sq=this.wList[A],sq&&this.b[sq]==W_PAWN){var v=RANK[sq],M=FILE[sq];9!=this.wPawns[M]&&(u-=WDOUBLED_PSTS[sq],T-=WDOUBLED_PSTE[sq],this.verbose&&this.etrace("white doubled",-WDOUBLED_PSTS[sq],-WDOUBLED_PSTE[sq],COORDS[sq])),v<this.wPawns[M]&&(this.wPawns[M]=v),O++,A++}else A++;this.bPawns[0]=0,this.bPawns[1]=0,this.bPawns[2]=0,this.bPawns[3]=0,this.bPawns[4]=0,this.bPawns[5]=0,this.bPawns[6]=0,this.bPawns[7]=0,this.bPawns[8]=0,this.bPawns[9]=0;for(var A=this.firstBP,O=0;S>O;)if(sq=this.bList[A],sq&&this.b[sq]==B_PAWN){var v=RANK[sq],M=FILE[sq];0!=this.bPawns[M]&&(u+=BDOUBLED_PSTS[sq],T+=BDOUBLED_PSTE[sq],this.verbose&&this.etrace("black doubled",BDOUBLED_PSTS[sq],BDOUBLED_PSTE[sq],COORDS[sq])),v>this.bPawns[M]&&(this.bPawns[M]=v),O++,A++}else A++;for(var A=this.firstWP,O=0;a>O;)if(sq=this.wList[A],sq&&this.b[sq]==W_PAWN){var v=RANK[sq],M=FILE[sq],p=1;v>=this.bPawns[M-1]&&v>=this.bPawns[M]&&v>=this.bPawns[M+1]&&(u+=WPASSED_PSTS[sq],T+=WPASSED_PSTE[sq],p=1,this.verbose&&this.etrace("white passed",WPASSED_PSTS[sq],WPASSED_PSTE[sq],COORDS[sq])),this.b[sq+11]==W_PAWN||this.b[sq+13]==W_PAWN?(u+=WCONNECT_PSTS[sq]*p,T+=WCONNECT_PSTE[sq]*p,this.verbose&&this.etrace("white connect",WCONNECT_PSTS[sq],WCONNECT_PSTE[sq],COORDS[sq])):9==this.wPawns[M-1]&&9==this.wPawns[M+1]&&(u-=WISOLATE_PSTS[sq],T-=WISOLATE_PSTE[sq],this.verbose&&this.etrace("white isolate",-WISOLATE_PSTS[sq],-WISOLATE_PSTE[sq],COORDS[sq])),O++,A++}else A++;for(var A=this.firstBP,O=0;S>O;)if(sq=this.bList[A],sq&&this.b[sq]==B_PAWN){var v=RANK[sq],M=FILE[sq],p=1;v<=this.wPawns[M-1]&&v<=this.wPawns[M]&&v<=this.wPawns[M+1]&&(u-=BPASSED_PSTS[sq],T-=BPASSED_PSTE[sq],p=1,this.verbose&&this.etrace("black passed",-BPASSED_PSTS[sq],-BPASSED_PSTE[sq],COORDS[sq])),this.b[sq-11]==B_PAWN||this.b[sq-13]==B_PAWN?(u-=BCONNECT_PSTS[sq]*p,T-=BCONNECT_PSTE[sq]*p,this.verbose&&this.etrace("black connect",-BCONNECT_PSTS[sq],-BCONNECT_PSTE[sq],COORDS[sq])):0==this.bPawns[M-1]&&0==this.bPawns[M+1]&&(u+=BISOLATE_PSTS[sq],T+=BISOLATE_PSTE[sq],this.verbose&&this.etrace("black isolate",BISOLATE_PSTS[sq],BISOLATE_PSTE[sq],COORDS[sq])),O++,A++}else A++;this.pttType[P]=TT_EXACT,this.pttLo[P]=this.ploHash,this.pttHi[P]=this.phiHash,this.pttScoreS[P]=u,this.pttScoreE[P]=T}s+=u,e+=T,this.verbose&&this.etrace("total pawns",u,T,""),h>=2&&(s+=50,e+=50,this.verbose&&this.etrace("white bishop bonus",50,50,"")),E>=2&&(s-=50,e-=50,this.verbose&&this.etrace("black bishop bonus",-50,-50,""));var d=1,f=32;this.b[_-12]==W_PAWN&&(s+=f,f>>>=d,e+=f,this.verbose&&this.etrace("white king safety",f<<d,f,COORDS[_-12])),this.b[_-13]==W_PAWN&&(s+=f,f>>>=d,e+=f,this.verbose&&this.etrace("white king safety",f<<d,f,COORDS[_-13])),this.b[_-11]==W_PAWN&&(s+=f,f>>>=d,e+=f,this.verbose&&this.etrace("white king safety",f<<d,f,COORDS[_-11]));var f=32;this.b[l+12]==B_PAWN&&(s-=f,f>>>=d,e-=f,this.verbose&&this.etrace("black king safety",-(f<<d),-f,COORDS[l+12])),this.b[l+11]==B_PAWN&&(s-=f,f>>>=d,e-=f,this.verbose&&this.etrace("black king safety",-(f<<d),-f,COORDS[l+11])),this.b[l+13]==B_PAWN&&(s-=f,f>>>=d,e-=f,this.verbose&&this.etrace("black king safety",-(f<<d),-f,COORDS[l+13])),this.mobility(WHITE),s+=this.mobilityS,e+=this.mobilityE,this.verbose&&this.etrace("white mobility",this.mobilityS,this.mobilityE,""),this.mobility(BLACK),s-=this.mobilityS,e-=this.mobilityE,this.verbose&&this.etrace("black mobility",this.mobilityS,this.mobilityE,"");var g=s*(256-this.gPhase)+e*this.gPhase>>8;return this.verbose&&(this.etrace("final eval",s,e,g),this.tab+="</table>",i.send("info string "+this.tab)),g*=-t>>31|1},lozBoard.prototype.rand32=function(){return Math.floor(4294967295*Math.random())+1},lozBoard.prototype.ttPut=function(t,i,s,e,r){var o=this.loHash&this.ttMask;this.hashUsed++,-MINMATE>=s&&s>=-MATE?s-=r:s>=MINMATE&&MATE>=s&&(s+=r),this.ttLo[o]=this.loHash,this.ttHi[o]=this.hiHash,this.ttType[o]=t,this.ttDepth[o]=i,this.ttScore[o]=s,this.ttMove[o]=e},lozBoard.prototype.ttGet=function(t,i,s,e){var r=this.loHash&this.ttMask,o=this.ttType[r];if(t.hashMove=0,o==TT_EMPTY)return TTSCORE_UNKNOWN;var h=this.ttLo[r],n=this.ttHi[r];if(h!=this.loHash||n!=this.hiHash)return TTSCORE_UNKNOWN;if(t.hashMove=this.ttMove[r],this.ttDepth[r]<i)return TTSCORE_UNKNOWN;var a=this.ttScore[r];return-MINMATE>=a&&a>=-MATE?a+=t.ply:a>=MINMATE&&MATE>=a&&(a-=t.ply),o==TT_EXACT?a:o==TT_ALPHA&&s>=a?a:o==TT_BETA&&a>=e?a:TTSCORE_UNKNOWN},lozBoard.prototype.ttGetMove=function(){var t=this.loHash&this.ttMask;return this.ttType[t]!=TT_EMPTY&&this.ttLo[t]==this.loHash&&this.ttHi[t]==this.hiHash?this.ttMove[t]:0},lozBoard.prototype.ttInit=function(){this.loHash=0,this.hiHash=0,this.ploHash=0,this.phiHash=0;for(var t=0;t<this.ttType.length;t++)this.ttType[t]=TT_EMPTY;for(var t=0;t<this.pttType.length;t++)this.pttType[t]=TT_EMPTY;this.hashUsed=0},lozBoard.prototype.hashCheck=function(t){var i=0,s=0,e=0,r=0;t&&(i^=this.loTurn,s^=this.hiTurn),i^=this.loRights[this.rights],s^=this.hiRights[this.rights],i^=this.loEP[this.ep],s^=this.hiEP[this.ep];for(var o=0;144>o;o++){var h=this.b[o];if(h!=NULL&&h!=EDGE){var n=h&PIECE_MASK,a=h&COLOR_MASK;i^=this.loPieces[a>>>3][n-1][o],s^=this.hiPieces[a>>>3][n-1][o],n==PAWN&&(e^=this.loPieces[a>>>3][0][o],r^=this.hiPieces[a>>>3][0][o])}}this.loHash!=i&&lozza.uci.debug("*************** LO",this.loHash,i),this.hiHash!=s&&lozza.uci.debug("*************** HI",this.hiHash,s),this.ploHash!=e&&lozza.uci.debug("************* PLO",this.ploHash,e),this.phiHash!=r&&lozza.uci.debug("************* PHI",this.phiHash,r)},lozBoard.prototype.fen=function(){var t="",s=0;for(i=0;8>i;i++){for(j=0;8>j;j++){var e=B88[8*i+j],r=this.b[e];r==NULL?s++:(s&&(t+=""+s,s=0),t+=UMAP[r])}s&&(t+=""+s,s=0),7>i&&(t+="/")}return t},lozBoard.prototype.playMove=function(t){var i=0,s=lozza.rootNode,e=~this.turn&COLOR_MASK;for(s.cache(),this.genMoves(s,this.turn);i=s.getNextMove();){this.makeMove(s,i);var r=this.isKingAttacked(e);if(r)this.unmakeMove(s,i),s.uncache();else{var o=this.formatMove(i,UCI_FMT);if(t==o||t+"q"==o)return this.turn=~this.turn&COLOR_MASK,!0;this.unmakeMove(s,i),s.uncache()}}return!1},lozBoard.prototype.getPVStr=function(t){if(!t)return"";var i=this.ttGetMove(t);if(!i)return"";t.cache(),this.makeMove(t,i);var s=this.formatMove(i,SAN_FMT),e=" "+this.getPVStr(t.childNode);return this.unmakeMove(t,i),t.uncache(),-1===e.indexOf(" "+s+" ")?s+e:s},lozBoard.prototype.etrace=function(t,i,s,e){this.tab+="<tr><td>"+t+"</td><td>"+i+"</td><td>"+s+"</td><td>"+e+"</td></tr>"},lozBoard.prototype.addHistory=function(t,i){var s=(i&MOVE_TOOBJ_MASK)>>>MOVE_FROBJ_BITS;if(!s){var e=(i&MOVE_TO_MASK)>>>MOVE_TO_BITS,r=(i&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS,o=r&PIECE_MASK;(r&COLOR_MASK)==WHITE?(this.wHistory[o][e]+=t*t,this.wHistory[o][e]>this.wHistory[0][0]&&(this.wHistory[0][0]=this.wHistory[o][e]),this.wHistory[o][e]>BASE_BADTAKES&&board.lozza.uci.debug("W HIS OVERFLOW")):(this.bHistory[o][e]+=t*t,this.bHistory[o][e]>this.bHistory[0][0]&&(this.bHistory[0][0]=this.bHistory[o][e]),this.bHistory[o][e]>BASE_BADTAKES&&board.lozza.uci.debug("B HIS OVERFLOW"))}};var WD={};WD.tuning={},WD.tuning.winBlack="b",WD.tuning.winWhite="w",WD.tuning.drawStalemate="d",WD.tuning.draw50="d",WD.tuning.drawRep="d",WD.playing={},WD.playing.winBlack="win by black",WD.playing.winWhite="win by white",WD.playing.drawStalemate="draw by stalemate",WD.playing.draw50="draw by 50 move rule",WD.playing.drawRep="draw by threefold repetition",lozBoard.prototype.isEnd=function(t){var i=(this.lozza.uci.spec,this.lozza.rootNode);if(this.lozza.uci.tuning)var s=WD.tuning;else var s=WD.playing;var e=this.isKingAttacked(BLACK),r=this.isKingAttacked(WHITE),o=0,h=0,n=0,a=[],E=[];for(i.cache(),this.genMoves(i,WHITE);o=i.getNextMove();)this.makeMove(i,o),this.isKingAttacked(BLACK)?(this.unmakeMove(i,o),i.uncache()):(a.push(o),h++,this.unmakeMove(i,o),i.uncache());for(this.genMoves(i,BLACK);o=i.getNextMove();)this.makeMove(i,o),this.isKingAttacked(WHITE)?(this.unmakeMove(i,o),i.uncache()):(E.push(o),n++,this.unmakeMove(i,o),i.uncache());var c="";0==h&&e&&t==WHITE?c=s.winBlack:0==n&&r&&t==BLACK?c=s.winWhite:0==h&&t==WHITE?c=s.drawStalemate:0==n&&t==BLACK?c=s.drawStalemate:this.repHi-this.repLo>=100&&(c=s.draw50);for(var S=this.repHi-5;S>=this.repLo;S-=2)this.repLoHash[S]==this.loHash&&this.repHiHash[S]==this.hiHash&&(c=s.drawRep);return c},lozNode.prototype.init=function(){this.killer1=0,this.killer2=0,this.mateKiller=0,this.numMoves=0,this.sortedIndex=0,this.hashMove=0,this.base=0,this.toZ=0,this.frZ=0,this.epZ=0},lozNode.prototype.cache=function(){var t=this.board;this.C_runningEvalS=t.runningEvalS,this.C_runningEvalE=t.runningEvalE,this.C_rights=t.rights,this.C_ep=t.ep,this.C_repLo=t.repLo,this.C_repHi=t.repHi,this.C_loHash=t.loHash,this.C_hiHash=t.hiHash,this.C_ploHash=t.ploHash,this.C_phiHash=t.phiHash},lozNode.prototype.uncache=function(){var t=this.board;t.runningEvalS=this.C_runningEvalS,t.runningEvalE=this.C_runningEvalE,t.rights=this.C_rights,t.ep=this.C_ep,t.repLo=this.C_repLo,t.repHi=this.C_repHi,t.loHash=this.C_loHash,t.hiHash=this.C_hiHash,t.ploHash=this.C_ploHash,t.phiHash=this.C_phiHash},lozNode.prototype.getNextMove=function(){if(this.sortedIndex==this.numMoves)return 0;for(var t=-INFINITY,i=0,s=this.sortedIndex;s<this.numMoves;s++)this.moves[s][0]>t&&(t=this.moves[s][0],i=s);var e=this.moves[this.sortedIndex],r=this.moves[i],o=e[0],h=e[1];return e[0]=r[0],e[1]=r[1],r[0]=o,r[1]=h,this.base=this.moves[this.sortedIndex][0],this.moves[this.sortedIndex++][1]};var BASE_HASH=100012e3,BASE_PROMOTES=100011e3,BASE_GOODTAKES=10001e4,BASE_EVENTAKES=100009e3,BASE_EPTAKES=100008e3,BASE_MATEKILLER=100007e3,BASE_MYKILLERS=100006e3,BASE_GPKILLERS=100005e3,BASE_CASTLING=100004e3,BASE_BADTAKES=100003e3,BASE_HISSLIDE=2e3,BASE_PSTSLIDE=1e3,BASE_LMR=BASE_BADTAKES;lozNode.prototype.addMove=function(t){var i=this.moves[this.numMoves++];if(i[1]=t,t==this.hashMove)return void(i[0]=BASE_HASH);if(t&MOVE_PROMOTE_MASK)return void(i[0]=BASE_PROMOTES+((t&MOVE_PROMAS_MASK)>>>MOVE_PROMAS_BITS));if(t&MOVE_EPTAKE_MASK)return void(i[0]=BASE_EPTAKES);if(t==this.mateKiller)return void(i[0]=BASE_MATEKILLER);if(t==this.killer1)return void(i[0]=BASE_MYKILLERS+1);if(t==this.killer2)return void(i[0]=BASE_MYKILLERS);if(this.grandparentNode&&t==this.grandparentNode.killer1)return void(i[0]=BASE_GPKILLERS+1);if(this.grandparentNode&&t==this.grandparentNode.killer2)return void(i[0]=BASE_GPKILLERS);if(t&MOVE_CASTLE_MASK)return void(i[0]=BASE_CASTLING);if(t&MOVE_TOOBJ_MASK){var s=RANK_VECTOR[(t&MOVE_TOOBJ_MASK)>>>MOVE_TOOBJ_BITS&PIECE_MASK],e=RANK_VECTOR[(t&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS&PIECE_MASK];return void(i[0]=s>e?BASE_GOODTAKES+64*s-e:s==e?BASE_EVENTAKES+64*s-e:BASE_BADTAKES+64*s-e)}var r=this.board,o=(t&MOVE_TO_MASK)>>>MOVE_TO_BITS,h=(t&MOVE_FR_MASK)>>>MOVE_FR_BITS,n=(t&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS,a=n&PIECE_MASK,E=n&COLOR_MASK;if(E==WHITE)var c=WM_PST[a],S=r.wHistory[a][o];else var c=BM_PST[a],S=r.bHistory[a][o];i[0]=S?BASE_HISSLIDE+S:BASE_PSTSLIDE+c[o]-c[h]},lozNode.prototype.addQMove=function(t){var i=this.moves[this.numMoves++];if(i[1]=t,t&MOVE_PROMOTE_MASK)return void(i[0]=BASE_PROMOTES+((t&MOVE_PROMAS_MASK)>>>MOVE_PROMAS_BITS));if(t&MOVE_EPTAKE_MASK)return void(i[0]=BASE_EPTAKES);var s=RANK_VECTOR[(t&MOVE_TOOBJ_MASK)>>>MOVE_TOOBJ_BITS&PIECE_MASK],e=RANK_VECTOR[(t&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS&PIECE_MASK];i[0]=s>e?BASE_GOODTAKES+64*s-e:s==e?BASE_EVENTAKES+64*s-e:BASE_BADTAKES+64*s-e},lozNode.prototype.addPromotion=function(t){this.addMove(t|QUEEN-2<<MOVE_PROMAS_BITS),this.addMove(t|ROOK-2<<MOVE_PROMAS_BITS),this.addMove(t|BISHOP-2<<MOVE_PROMAS_BITS),this.addMove(t|KNIGHT-2<<MOVE_PROMAS_BITS)},lozNode.prototype.addQPromotion=function(t){this.addQMove(t|QUEEN-2<<MOVE_PROMAS_BITS)},lozNode.prototype.addKiller=function(t,i){if(i!=this.hashMove&&!(i&(MOVE_EPTAKE_MASK|MOVE_PROMOTE_MASK))){if(i&MOVE_TOOBJ_MASK){var s=RANK_VECTOR[(i&MOVE_TOOBJ_MASK)>>>MOVE_TOOBJ_BITS&PIECE_MASK],e=RANK_VECTOR[(i&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS&PIECE_MASK];if(s>=e)return}if(t>=MINMATE&&MATE>=t)return this.mateKiller=i,this.killer1==i&&(this.killer1=0),void(this.killer2==i&&(this.killer2=0));if(this.killer1!=i&&this.killer2!=i){if(0==this.killer1)return void(this.killer1=i);if(0==this.killer2)return void(this.killer2=i);var r=this.killer1;this.killer1=i,this.killer2=r}}},lozStats.prototype.init=function(){this.startTime=Date.now(),this.splitTime=0,this.nodes=0,this.ply=0,this.splits=0,this.moveTime=0,this.maxNodes=0,this.timeOut=0,this.selDepth=0,this.bestMove=0},lozStats.prototype.lazyUpdate=function(){this.moveTime>0&&Date.now()-this.startTime>this.moveTime&&(this.timeOut=1),this.maxNodes>0&&this.nodes>=this.maxNodes&&(this.timeOut=1),Date.now()-this.splitTime>500&&(this.splits++,this.update(),this.splitTime=Date.now())},lozStats.prototype.update=function(){if(!lozza.uci.tuning){var t=Date.now()-this.startTime,i=Math.floor(1e3*this.nodes/t);lozza.uci.send("info nodes",this.nodes,"time",t,"nps",i)}},lozStats.prototype.stop=function(){this.stopTime=Date.now(),this.time=this.stopTime-this.startTime,this.timeSec=Math.round(this.time/100)/10,this.nodesMega=Math.round(this.nodes/1e5)/10
},lozUCI.prototype.send=function(){for(var t="",i=0;i<arguments.length;i++)t+=arguments[i]+" ";postMessage(t)},lozUCI.prototype.debug=function(){if(this.debugging){for(var t="",i=0;i<arguments.length;i++)t+=arguments[i]+" ";t=t.trim(),postMessage(t?"info string debug "+this.spec.id+" "+t:"info string")}},lozUCI.prototype.getInt=function(t,i){for(var s=0;s<this.tokens.length;s++)if(this.tokens[s]==t&&s<this.tokens.length-1)return parseInt(this.tokens[s+1]);return i},lozUCI.prototype.getStr=function(t,i){for(var s=0;s<this.tokens.length;s++)if(this.tokens[s]==t&&s<this.tokens.length-1)return this.tokens[s+1];return i},lozUCI.prototype.getArr=function(t,i){for(var s=0,e=0,r=0;r<this.tokens.length;r++)if(this.tokens[r]==t){s=r+1,e=s;for(var o=s;o<this.tokens.length&&this.tokens[o]!=i;o++)e=o}return{lo:s,hi:e}},onmessage=function(t){var i=lozza.uci;i.messageList=t.data.split("\n");for(var s=0;s<i.messageList.length;s++)switch(i.message=i.messageList[s].replace(/(\r\n|\n|\r)/gm,""),i.message=i.message.trim(),i.message=i.message.replace(/\s+/g," "),i.tokens=i.message.split(" "),i.command=i.tokens[0],i.command){case"position":i.spec.board="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",i.spec.turn="w",i.spec.rights="KQkq",i.spec.ep="-",i.spec.hmc=0,i.spec.fmc=1,i.spec.id="",i.spec.validate=i.getInt("validate",0),i.spec.fen="";var e=i.getArr("fen","moves");e.lo>0&&(e.lo<=e.hi&&(i.spec.board=i.tokens[e.lo]),e.lo++,e.lo<=e.hi&&(i.spec.turn=i.tokens[e.lo]),e.lo++,e.lo<=e.hi&&(i.spec.rights=i.tokens[e.lo]),e.lo++,e.lo<=e.hi&&(i.spec.ep=i.tokens[e.lo]),e.lo++,e.lo<=e.hi&&(i.spec.hmc=parseInt(i.tokens[e.lo])),e.lo++,e.lo<=e.hi&&(i.spec.fmc=parseInt(i.tokens[e.lo])),e.lo++),i.spec.moves=[];var e=i.getArr("moves","fen");if(e.lo>0)for(var r=e.lo;r<=e.hi;r++)i.spec.moves.push(i.tokens[r]);var o=lozza.position();i.spec.validate&&i.send("valid",o,"txfen",i.spec.fen);break;case"go":i.spec.depth=i.getInt("depth",0),i.spec.moveTime=i.getInt("movetime",0),i.spec.maxNodes=i.getInt("nodes",0),i.spec.wTime=i.getInt("wtime",0),i.spec.bTime=i.getInt("btime",0),i.spec.wInc=i.getInt("winc",0),i.spec.bInc=i.getInt("binc",0),i.spec.movesToGo=i.getInt("movestogo",0),i.spec.txfen=i.getInt("txfen",0),lozza.go();break;case"ucinewgame":lozza.newGameInit();break;case"quit":close();break;case"debug":i.debugging="on"==i.getStr("debug","off")?!0:!1;break;case"tuning":i.getInt("tuning",0)?(i.tuning=!0,i.tune1=i.getInt("tune1",0)):i.tuning=!1;break;case"uci":i.send("id name Lozza"),i.send("id author Colin Jenkins"),i.send("option"),i.send("uciok");break;case"isready":i.send("readyok");break;case"setoption":var h=i.getStr("name"),n=i.getStr("value");i.options[h]=n;break;case"ping":i.send("info string Lozza version",MAJOR+"."+MINOR,"build",BUILD,"is alive");break;case"id":i.spec.id=i.tokens[1];break;case"perft":i.spec.depth=i.getInt("depth",0),i.spec.moves=i.getInt("moves",0),i.spec.inner=i.getInt("inner",0),lozza.perft();break;case"eval":lozza.board.verbose=!0,lozza.board.evaluate(lozza.board.turn),lozza.board.verbose=!1;break;case"board":i.send("board",i.spec.board);break;default:i.send("info string",i.command,"?")}};var lozza=new lozChess;lozza.board.lozza=lozza,angular.module("chess.services",[]),angular.module("chess.services").factory("clickTracker",function(){var t=function(){var t,i;this.setX=function(i){t=i},this.getX=function(){return t},this.setY=function(t){i=t},this.getY=function(){return i},this.reset=function(){t=i=void 0}};return new t}).factory("chessClickMove",["clickTracker",function(t){var i=function(){this.activate=function(i,s,e){i.on("click",function(){var i=t.getX(),r=t.getY(),o=s.getScope(),h=o.content.piece;if(void 0===i||void 0===r){if(!h)return;o.isMovable()&&(t.setX(h.x),t.setY(h.y),o.$apply(function(){e.displayAccessibleMoves(o.content.piece)}))}else t.reset(),e.tryMove(i,r,o.content.x,o.content.y)})},this.deactivate=function(t){t.off("click")}};return new i}]),angular.module("chess.services").constant("chessConstants",{moveMode:{dragndrop:"dragndrop",click:"click"},control:{all:"all",edit:"edit",user:"user"},user:{white:"white",black:"black"}}),angular.module("chess.services").factory("chessDragDropMove",["chessPieceService","chessConstants",function(t,i){var s=function(){this.activate=function(s,e,r){s.on("dragover",function(t){t.preventDefault&&t.preventDefault()}),s.on("dragenter",function(){this.classList.add("overSquare")}),s.on("dragleave",function(t){this.classList.remove("overSquare"),t.stopPropagation()}),s.on("dragstart",function(t){var i=e.getScope(),s="in "+i.content.piece.x+" "+i.content.piece.y,o=i.getImage()[0],h=o.width/2,n=o.height/2;t.dataTransfer.setData("piece",s),t.dataTransfer.setDragImage(o,h,n),i.$apply(function(){r.displayAccessibleMoves(i.content.piece)})}),s.on("drop",function(s){s.preventDefault&&s.preventDefault(),s.stopPropagation&&s.stopPropagation(),this.classList.remove("overSquare");var o=s.dataTransfer.getData("piece");if(void 0!==o){var h=o.split(" "),n=h[0],a=r.getControl(),E=e.getScope();if("in"===n){var c=parseInt(h[1]),S=parseInt(h[2]);r.tryMove(c,S,E.content.x,E.content.y)}else if("out"===n&&a===i.control.edit){var _=h[1],l=h[2];piece=t.new(_,l,E.content.x,E.content.y),r.addPiece(piece)}}})},this.deactivate=function(t){t.off("dragover"),t.off("dragenter"),t.off("dragleave"),t.off("dragstart"),t.off("drop")}};return new s}]),angular.module("chess.services").factory("chessEngineService",[function(){var t=function(){var t=new Worker("/ext/lozza.js");t.onmessage=function(t){{var i=t.data.trim().replace(/\s+/g," ");i.split(" ")}},this.play=function(){}};return new t}]),angular.module("chess.services").factory("chessMoveService",["chessPositionService",function(t){var i=function(t,i){for(var s=[],e=t-1;e>=0;e--)s.push([e,i]);return s},s=function(t,i){for(var s=[],e=t+1;7>=e;e++)s.push([e,i]);return s},e=function(t,i){for(var s=[],e=i-1;e>=0;e--)s.push([t,e]);return s},r=function(t,i){for(var s=[],e=i+1;7>=e;e++)s.push([t,e]);return s},o=function(t,i){for(var s=[],e=0,r=t-1;r>=0&&(e++,!(i+e>7));r--)s.push([r,i+e]);return s},h=function(t,i){for(var s=[],e=0,r=t-1;r>=0&&(e++,!(0>i-e));r--)s.push([r,i-e]);return s},n=function(t,i){for(var s=[],e=0,r=t+1;7>=r&&(e++,!(0>i-e));r++)s.push([r,i-e]);return s},a=function(t,i){for(var s=[],e=0,r=t+1;7>=r&&(e++,!(i+e>7));r++)s.push([r,i+e]);return s},E=function(t,i){var s,e=[],r=[[1,2],[1,-2],[2,1],[2,-1],[-1,2],[-1,-2],[-2,1],[-2,-1]];for(var o in r)s=r[o],t+s[0]>=0&&t+s[0]<=7&&i+s[1]>=0&&i+s[1]<=7&&e.push([t+s[0],i+s[1]]);return e},c=function(i,s,e,r){if(!(i>=0&&8>i&&s>=0&&8>s))return!1;var o=t.getPiece(i,s,r);return!o||o.colorType!==e&&"KING"!==o.type},S=function(t,i,s){var e=[],r=[[-1,-1],[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1],[0,-1]];for(var o in r){var h=r[o];x=i.x+h[0],y=i.y+h[1],c(x,y,t,s)&&e.push({x:x,y:y})}return e},_=function(E,S,_){var l=[],u=[i(S.x,S.y),s(S.x,S.y),r(S.x,S.y),e(S.x,S.y),o(S.x,S.y),a(S.x,S.y),h(S.x,S.y),n(S.x,S.y)];for(var T in u){var P=u[T];for(var A in P){var O=P[A],v={x:O[0],y:O[1]};if(!c(v.x,v.y,E,_))break;l.push(v);var M=t.getPiece(v.x,v.y,_);if(void 0!==M)break}}return l},l=function(o,h,n){var a=[],E=[i(h.x,h.y),s(h.x,h.y),r(h.x,h.y),e(h.x,h.y)];for(var S in E){var _=E[S];for(var l in _){var u=_[l],T={x:u[0],y:u[1]};if(!c(T.x,T.y,o,n))break;a.push(T);var P=t.getPiece(T.x,T.y,n);if(void 0!==P)break}}return a},u=function(i,s,e){var r=[],E=[o(s.x,s.y),h(s.x,s.y),a(s.x,s.y),n(s.x,s.y)];for(var S in E){var _=E[S];for(var l in _){var u=_[l],T={x:u[0],y:u[1]};if(!c(T.x,T.y,i,e))break;r.push(T);var P=t.getPiece(T.x,T.y,e);if(void 0!==P)break}}return r},T=function(t,i,s){var e=[],r=E(i.x,i.y);for(var o in r){var h=r[o],n=h[0],a=h[1];c(n,a,t,s)&&e.push({x:n,y:a})}return e},P=function(i,s,e){var r=[];if(0===s.y&&"BLACK"===i||7===s.y&&"WHITE"===i)return r;var o="WHITE"===i?s.y+1:s.y-1,h=t.getPiece(s.x,o,e);h||r.push({x:s.x,y:o}),!h&&(1===s.y&&"WHITE"===i||6===s.y&&"BLACK"===i)&&(o="WHITE"===i?s.y+2:s.y-2,h=t.getPiece(s.x,o,e),h||r.push({x:s.x,y:o}));var n,a,E,c;return s.x>0&&(n={x:s.x-1,y:"WHITE"===i?s.y+1:s.y-1}),s.x<7&&(a={x:s.x+1,y:"WHITE"===i?s.y+1:s.y-1}),n&&(E=t.getPiece(n.x,n.y,e),E&&E.colorType!==i&&r.push(n)),a&&(c=t.getPiece(a.x,a.y,e),c&&c.colorType!==i&&r.push(a)),r},A=function(t,i,s,e){switch(t){case"KING":return S(i,s,e);case"QUEEN":return _(i,s,e);case"ROOK":return l(i,s,e);case"BISHOP":return u(i,s,e);case"KNIGHT":return T(i,s,e);case"PAWN":return P(i,s,e)}},O=function(i,s){var e=t.getKing(s,i),r=["PAWN","ROOK","BISHOP","KNIGHT","QUEEN"];for(var o in r){var h=r[o],n=A(h,s,{x:e.x,y:e.y},i);for(var o in n){var a=n[o],E=t.getPiece(a.x,a.y,i);if(E&&E.colorType!==s&&E.type===h)return!0}}},v=function(i){var s=[],e=A(i.type,i.colorType,{x:i.x,y:i.y},t.getPosition());if(e&&e.length>0){var r=t.clonePosition();t.dropPiece(i,r);var o=void 0;"KING"!==i.type&&(o=O(r,i.colorType)),t.unclonePosition(r);var h,n=o||"KING"===i.type;for(var a in e){var E=e[a];n?(r=t.clonePosition(),h=t.getPiece(i.x,i.y,r),t.movePiece(h,E.x,E.y,r),O(r,h.colorType)||s.push(E),t.unclonePosition(r)):s.push(E)}}return s},M=function(){this.getMoves=v};return new M}]),angular.module("chess.services").factory("chessPieceService",function(){var t=function(){var t=this;this.types={KING:"king",QUEEN:"queen",ROOK:"rook",BISHOP:"bishop",KNIGHT:"knight",PAWN:"pawn"},this.colors={WHITE:"white",BLACK:"black"};var i=function(i){for(var s in t.types)if(t.types[s]===i)return s},s=function(i){for(var s in t.colors)if(t.colors[s]===i)return s},e=function(t,e,r,o){this.type=i(t),this.colorType=s(e),this.name=t,this.color=e,this.x=r,this.y=o};this.new=function(i,s,r,o){if(void 0===t.types[i])throw"Unknown piece name :"+i;if(void 0===t.colors[s])throw"Unknown color :"+s;if(0>r||r>7||0>o||o>7)throw"Position unauthorized : ("+r+","+o+")";return new e(t.types[i],t.colors[s],r,o)},this.clone=function(i){return t.new(i.type,i.colorType,i.x,i.y)},this.fromData=function(t){return new e(t.name,t.color,t.x,t.color)},this.setPosition=function(t,i,s){if(0>i||i>7||0>s||s>7)throw"Position unauthorized : ("+i+","+s+")";t.x=i,t.y=s}};return new t}),angular.module("chess.services").provider("chessPositionService",function(){var t,i,s=[],e=!1,r=[];this.setPosition=function(t){s=t,e=!0},this.$get=["chessPieceService",function(o){var h=function(){if(!e){var r,h,a;for(h=0;64>h;h++)s.push(void 0);for(r=0;8>r;r++)n(o.new("PAWN","WHITE",r,1)),n(o.new("PAWN","BLACK",r,6));for(h=0,a=[0,7];h<a.length;h++)n(o.new("ROOK","WHITE",a[h],0)),n(o.new("ROOK","BLACK",a[h],7));for(h=0,a=[2,5];h<a.length;h++)n(o.new("BISHOP","WHITE",a[h],0)),n(o.new("BISHOP","BLACK",a[h],7));for(h=0,a=[1,6];h<a.length;h++)n(o.new("KNIGHT","WHITE",a[h],0)),n(o.new("KNIGHT","BLACK",a[h],7));n(o.new("QUEEN","WHITE",3,0)),n(o.new("QUEEN","BLACK",3,7)),t=o.new("KING","WHITE",4,0),i=o.new("KING","BLACK",4,7),n(t),n(i)}},n=function(t,i){var e=i?i:s,r=t.x,o=t.y;indice=8*o+r,e[indice]=t},a=function(t,i,e){var r=e?e:s;r[8*i+t]=void 0},E=function(t,i){a(t.x,t.y,i)},c=function(){return this.lastMove},S=!1,_=function(){return S},l=function(t,i,s,e){var r=function(){this.lastMove={from:{x:t.x,y:t.y},to:{x:i,y:s}},S=!0};if(S=!1,void 0!==e){var o;for(var h in e)if(o=e[h],o.x===i&&o.y===s){r.apply(this);break}}else r.apply(this)},u=function(t,i,e,r){var h=r?r:s,a=t.x,E=t.y;sourceInd=8*E+a,h[sourceInd]=void 0,o.setPosition(t,i,e),n(t,h),S=!1},T=function(){return s},P=function(t,i,e){return posToUse=e?e:s,posToUse[8*i+t]},A=function(s,e){var o,h;if(e)for(var n in r){var a=r[n];a.position===e&&(o=a.whiteKing,h=a.blackKing)}else o=t,o=i;return"WHITE"===s?o:h},O=function(t){s=t},v=function(){for(var t in s)s[t]=void 0},M=function(){var t,i,e,h=[];for(var n in s)t=s[n],t&&(t=o.clone(t),"KING"===t.type&&("WHITE"===t.colorType?e=t:i=t)),h.push(t);return r.push({whiteKing:e,blackKing:i,position:h}),h},p=function(t){for(var i in r){var s=r[i];if(s.position===t){r.splice(i,1);break}}},d=function(){h(),this.addPiece=n,this.dropPosition=a,this.dropPiece=E,this.getLastMove=c,this.isMoveAccepted=_,this.checkMove=l,this.movePiece=u,this.getPosition=T,this.getPiece=P,this.getKing=A,this.setNewPosition=O,this.clearPosition=v,this.clonePosition=M,this.unclonePosition=p};return new d}]}),angular.module("chess.services").provider("chessResources",function(){var t={imgsRootPath:"/imgs"};this.setImgsRootPath=function(i){var s=i;void 0!==s&&("/"===i.substring(i.length-1)&&(s=i.substring(0,i.length-1)),t.imgsRootPath=s)},this.$get=[function(){var i=function(){this.getImgsRootPath=function(){return t.imgsRootPath},this.getPieceImage=function(t,i){return this.getImgsRootPath()+"/"+t+"_"+i+".svg"},this.getTrash=function(){return this.getImgsRootPath()+"/trash.svg"}};return new i}]});